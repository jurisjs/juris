<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory-Optimized Virtual Scroll - Juris</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .table-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #fafafa;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .table-scroll-container {
            position: relative;
            height: 600px;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .virtual-spacer {
            position: absolute;
            top: 0;
            left: 0;
            width: 1px;
            pointer-events: none;
        }
        
        .virtual-content {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
        }
        
        .table-row {
            position: absolute;
            left: 0;
            right: 0;
            display: flex;
            background: white;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
            cursor: pointer;
            user-select: none;
        }
        
        .table-row:hover {
            background: #f8f9fa;
        }
        
        .table-row.selected {
            background: #e3f2fd !important;
            border-bottom: 1px solid #90caf9;
        }
        
        .table-row.selected:hover {
            background: #bbdefb !important;
        }
        
        .table-row.last-selected {
            box-shadow: inset 0 0 0 2px #2196f3;
        }
        
        .table-row.new-row {
            background: #e8f5e9 !important;
            animation: fadeIn 0.5s ease;
        }
        
        .table-row.inserted-from-route {
            background: #f3e5f5 !important;
            animation: fadeInPurple 0.5s ease;
        }
        
        .table-row.marked-delete {
            background: #ffebee !important;
            opacity: 0.8;
        }
        
        @keyframes fadeIn {
            from { background: #a5d6a7; }
            to { background: #e8f5e9; }
        }
        
        @keyframes fadeInPurple {
            from { background: #ba68c8; }
            to { background: #f3e5f5; }
        }
        
        .header-row {
            display: flex;
            background: #fafafa;
            font-weight: 600;
            position: relative;
        }
        
        .table-cell {
            padding: 12px 8px;
            border-right: 1px solid #e8e8e8;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 14px;
        }
        
        .header-cell {
            padding: 12px 8px;
            border-right: 1px solid #d0d0d0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: 600;
            background: #fafafa;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #666;
        }
        
        .stats-panel {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 30px;
            font-size: 14px;
            align-items: center;
        }
        
        .stat-item {
            display: flex;
            gap: 8px;
        }
        
        .stat-label {
            color: #666;
            font-weight: 500;
        }
        
        .stat-value {
            color: #333;
            font-weight: 700;
        }
        
        .selection-actions {
            margin-left: auto;
            display: flex;
            gap: 10px;
        }
        
        .selection-btn {
            padding: 6px 12px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .selection-btn:hover {
            background: #1976d2;
        }
        
        .selection-btn.clear {
            background: #f44336;
        }
        
        .selection-btn.clear:hover {
            background: #d32f2f;
        }
        
        .memory-debug {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            z-index: 10000;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    
    <script src="../src/juris.js"></script>
    <script>
        // Memory tracking utilities
        const MemoryTracker = {
            componentCount: 0,
            eventListenerCount: 0,
            subscriptionCount: 0,
            domNodeCount: 0,
            
            increment(type) {
                this[type + 'Count']++;
                this.updateDebugDisplay();
            },
            
            decrement(type) {
                this[type + 'Count']--;
                this.updateDebugDisplay();
            },
            
            updateDebugDisplay() {
                const debugEl = document.querySelector('.memory-debug');
                if (debugEl) {
                    debugEl.innerHTML = `
                        Components: ${this.componentCount}<br>
                        Event Listeners: ${this.eventListenerCount}<br>
                        Subscriptions: ${this.subscriptionCount}<br>
                        DOM Nodes: ${this.domNodeCount}
                    `;
                }
            }
        };

        // Generate sample data
        const generateTableData = (count) => {
            const data = [];
            for (let i = 0; i < count; i++) {
                data.push({
                    id: i + 1,
                    oper: `${String(i % 100).padStart(2, '0')}`,
                    workArea: ['FMLT', 'ASSY', 'TEST', 'PACK'][i % 4],
                    script: ['FMLTXG', 'ASSYQA', 'TESTRUN', 'PACKSHIP'][i % 4],
                    eMaxDelay: i % 3 === 0,
                    event: `EVENT${String(i % 50).padStart(3, '0')}`,
                    reworkOper: `${9000 + (i % 1000)}`,
                    reworkRoute: `RWIM-${String(i % 100).padStart(4, '0')}`,
                    returnOper: `${100 + (i % 200)}`,
                    isNew: false,
                    insertedFromRoute: false,
                    markedForDelete: false
                });
            }
            return data;
        };

        // Memory-optimized Table Cell Component
        const TableCell = (props, context) => {
            const { getState } = context;
            
            MemoryTracker.increment('component');
            
            return {
                div: {
                    class: 'table-cell',
                    style: () => ({
                        width: `${getState(`ui.table.columnWidths.${props.columnName}`, 100)}px`,
                        minWidth: `${getState(`ui.table.columnWidths.${props.columnName}`, 100)}px`,
                        maxWidth: `${getState(`ui.table.columnWidths.${props.columnName}`, 100)}px`
                    }),
                    title: props.value,
                    text: props.value !== undefined && props.value !== null ? String(props.value) : ''
                },
                
                // Component lifecycle with proper cleanup
                onUnmount: () => {
                    MemoryTracker.decrement('component');
                }
            };
        };

        // Memory-optimized Table Row Component
        const TableRow = (props, context) => {
            const { getState } = context;
            const { rowIndex, row, rowHeight, onRowClick } = props;
            
            MemoryTracker.increment('component');
            
            // Pre-calculate static values to avoid repeated getState calls
            const staticData = {
                id: row.id,
                action: row.markedForDelete ? 'R' : 'C',
                oper: row.oper,
                workArea: row.workArea,
                script: row.script,
                eMaxDelay: row.eMaxDelay ? 'Yes' : 'No',
                event: row.event,
                reworkOper: row.reworkOper,
                reworkRoute: row.reworkRoute,
                returnOper: row.returnOper
            };
            
            return {
                div: {
                    class: () => {
                        const selectedRows = getState('ui.table.selectedRows', []);
                        const lastSelectedRow = getState('ui.table.lastSelectedRow', null);
                        
                        let className = 'table-row';
                        if (selectedRows.includes(rowIndex)) className += ' selected';
                        if (rowIndex === lastSelectedRow) className += ' last-selected';
                        if (row.isNew) className += ' new-row';
                        if (row.insertedFromRoute) className += ' inserted-from-route';
                        if (row.markedForDelete) className += ' marked-delete';
                        return className;
                    },
                    key: `row-${rowIndex}`,
                    style: {
                        top: `${rowIndex * rowHeight}px`,
                        height: `${rowHeight}px`
                    },
                    onclick: (e) => {
                        MemoryTracker.increment('eventListener');
                        onRowClick(rowIndex, e);
                    },
                    children: [
                        { TableCell: { columnName: 'id', value: staticData.id } },
                        { TableCell: { columnName: 'action', value: staticData.action } },
                        { TableCell: { columnName: 'oper', value: staticData.oper } },
                        { TableCell: { columnName: 'workArea', value: staticData.workArea } },
                        { TableCell: { columnName: 'script', value: staticData.script } },
                        { TableCell: { columnName: 'eMaxDelay', value: staticData.eMaxDelay } },
                        { TableCell: { columnName: 'event', value: staticData.event } },
                        { TableCell: { columnName: 'reworkOper', value: staticData.reworkOper } },
                        { TableCell: { columnName: 'reworkRoute', value: staticData.reworkRoute } },
                        { TableCell: { columnName: 'returnOper', value: staticData.returnOper } }
                    ]
                },
                
                // Component lifecycle with proper cleanup
                onUnmount: () => {
                    MemoryTracker.decrement('component');
                    MemoryTracker.decrement('eventListener');
                }
            };
        };

        // Memory-optimized Virtual Container
        const VirtualContainer = (props, context) => {
            const { getState, setState } = context;
            
            const ROW_HEIGHT = 42;
            const BUFFER_SIZE = 3; // Reduced buffer size
            const CONTAINER_HEIGHT = 600;
            
            // Throttled scroll handler to reduce memory pressure
            let scrollTimeout = null;
            const handleScroll = (e) => {
                if (scrollTimeout) {
                    clearTimeout(scrollTimeout);
                }
                
                scrollTimeout = setTimeout(() => {
                    setState('ui.table.scrollTop', e.target.scrollTop);
                    scrollTimeout = null;
                }, 16); // ~60fps
            };
            
            const calculateVisibleRange = () => {
                const scrollTop = getState('ui.table.scrollTop', 0);
                const data = getState('tableData', [], false); // Don't track for calculations
                const start = Math.max(0, Math.floor(scrollTop / ROW_HEIGHT) - BUFFER_SIZE);
                const end = Math.min(
                    data.length,
                    Math.ceil((scrollTop + CONTAINER_HEIGHT) / ROW_HEIGHT) + BUFFER_SIZE
                );
                return { start, end };
            };
            
            return {
                div: {
                    class: 'table-scroll-container',
                    onscroll: handleScroll,
                    children: [
                        // Virtual Spacer - minimal reactivity
                        {
                            div: {
                                class: 'virtual-spacer',
                                style: () => {
                                    const dataLength = getState('tableData', []).length;
                                    MemoryTracker.domNodeCount = dataLength; // Track total rows
                                    return { height: `${dataLength * ROW_HEIGHT}px` };
                                }
                            }
                        },
                        
                        // Virtual Content - optimized rendering
                        {
                            div: {
                                class: 'virtual-content',
                                children: () => {
                                    const range = calculateVisibleRange();
                                    const data = getState('tableData', []);
                                    const visibleRows = [];
                                    
                                    // Only create components for visible rows
                                    for (let i = range.start; i < range.end; i++) {
                                        const row = data[i];
                                        if (!row) continue;
                                        
                                        visibleRows.push({
                                            TableRow: {
                                                key: `row-${i}`,
                                                rowIndex: i,
                                                row: row,
                                                rowHeight: ROW_HEIGHT,
                                                onRowClick: props.onRowClick
                                            }
                                        });
                                    }
                                    
                                    return visibleRows;
                                }
                            }
                        }
                    ]
                },
                
                // Cleanup scroll timeout on unmount
                onUnmount: () => {
                    if (scrollTimeout) {
                        clearTimeout(scrollTimeout);
                        scrollTimeout = null;
                    }
                }
            };
        };

        // Main RouteTable Component with memory optimizations
        const RouteTable = (props, context) => {
            const { getState, setState, juris } = context;
            
            MemoryTracker.increment('component');
            
            // Optimized row click handler with batching
            const handleRowClick = (rowIndex, event) => {
                juris.executeBatch(() => {
                    const currentSelectedRows = getState('ui.table.selectedRows', []);
                    const lastSelectedRow = getState('ui.table.lastSelectedRow');
                    let newSelectedRows = [];
                    
                    if (event.ctrlKey || event.metaKey) {
                        if (currentSelectedRows.includes(rowIndex)) {
                            newSelectedRows = currentSelectedRows.filter(i => i !== rowIndex);
                        } else {
                            newSelectedRows = [...currentSelectedRows, rowIndex];
                        }
                        setState('ui.table.lastSelectedRow', rowIndex);
                    } else if (event.shiftKey && lastSelectedRow !== null) {
                        const start = Math.min(lastSelectedRow, rowIndex);
                        const end = Math.max(lastSelectedRow, rowIndex);
                        const rangeSet = new Set(currentSelectedRows);
                        for (let i = start; i <= end; i++) {
                            rangeSet.add(i);
                        }
                        newSelectedRows = Array.from(rangeSet);
                    } else {
                        newSelectedRows = [rowIndex];
                        setState('ui.table.lastSelectedRow', rowIndex);
                    }
                    
                    setState('ui.table.selectedRows', newSelectedRows);
                });
            };
            
            // Memory-conscious action handlers
            const selectAll = () => {
                juris.executeBatch(() => {
                    const data = getState('tableData', []);
                    const allRows = Array.from({ length: data.length }, (_, i) => i);
                    setState('ui.table.selectedRows', allRows);
                    setState('ui.table.lastSelectedRow', data.length - 1);
                });
            };
            
            const clearSelection = () => {
                juris.executeBatch(() => {
                    setState('ui.table.selectedRows', []);
                    setState('ui.table.lastSelectedRow', null);
                });
            };
            
            const forceCleanup = () => {
                // Force garbage collection (development only)
                if (window.gc) {
                    window.gc();
                }
                
                // Clear any lingering references
                juris.cleanup();
                
                // Trigger re-render to recreate clean components
                setState('ui.table.forceRefresh', Date.now());
            };
            
            return {
                div: {
                    class: 'table-container',
                    children: [
                        // Memory Debug Panel
                        {
                            div: {
                                class: 'memory-debug',
                                text: () => {
                                    const selectedCount = getState('ui.table.selectedRows', []).length;
                                    const totalRows = getState('tableData', []).length;
                                    return `Selected: ${selectedCount} | Total: ${totalRows}`;
                                }
                            }
                        },
                        
                        // Stats Panel - Optimized
                        {
                            div: {
                                class: 'stats-panel',
                                children: [
                                    {
                                        div: {
                                            class: 'stat-item',
                                            children: [
                                                { span: { class: 'stat-label', text: 'Total Rows:' } },
                                                { span: { 
                                                    class: 'stat-value', 
                                                    text: () => getState('tableData', []).length 
                                                }}
                                            ]
                                        }
                                    },
                                    {
                                        div: {
                                            class: 'stat-item',
                                            children: [
                                                { span: { class: 'stat-label', text: 'Selected:' } },
                                                { span: { 
                                                    class: 'stat-value', 
                                                    text: () => getState('ui.table.selectedRows', []).length 
                                                }}
                                            ]
                                        }
                                    },
                                    {
                                        div: {
                                            class: 'selection-actions',
                                            children: [
                                                {
                                                    button: {
                                                        class: 'selection-btn',
                                                        text: 'Select All',
                                                        onclick: selectAll
                                                    }
                                                },
                                                () => {
                                                    const selectedCount = getState('ui.table.selectedRows', []).length;
                                                    if (selectedCount > 0) {
                                                        return {
                                                            button: {
                                                                class: 'selection-btn clear',
                                                                text: 'Clear',
                                                                onclick: clearSelection
                                                            }
                                                        };
                                                    }
                                                    return null;
                                                },
                                                {
                                                    button: {
                                                        class: 'selection-btn',
                                                        text: 'Force GC',
                                                        onclick: forceCleanup,
                                                        style: { 
                                                            background: '#ff9800',
                                                            fontSize: '11px'
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                ]
                            }
                        },
                        
                        // Table Header - Static
                        {
                            div: {
                                class: 'table-header',
                                children: [
                                    {
                                        div: {
                                            class: 'header-row',
                                            children: [
                                                { div: { class: 'header-cell', style: { width: '70px' }, text: 'ID' } },
                                                { div: { class: 'header-cell', style: { width: '50px' }, text: 'ACTION' } },
                                                { div: { class: 'header-cell', style: { width: '80px' }, text: 'OPER' } },
                                                { div: { class: 'header-cell', style: { width: '100px' }, text: 'WORK AREA' } },
                                                { div: { class: 'header-cell', style: { width: '120px' }, text: 'SCRIPT' } },
                                                { div: { class: 'header-cell', style: { width: '90px' }, text: 'E-MAX DELAY' } },
                                                { div: { class: 'header-cell', style: { width: '150px' }, text: 'EVENT' } },
                                                { div: { class: 'header-cell', style: { width: '100px' }, text: 'REWORK OPER' } },
                                                { div: { class: 'header-cell', style: { width: '110px' }, text: 'REWORK ROUTE' } },
                                                { div: { class: 'header-cell', style: { width: '100px' }, text: 'RETURN OPER' } }
                                            ]
                                        }
                                    }
                                ]
                            }
                        },
                        
                        // Virtual Container
                        {
                            VirtualContainer: {
                                onRowClick: handleRowClick
                            }
                        }
                    ]
                },
                
                // Component cleanup
                onUnmount: () => {
                    MemoryTracker.decrement('component');
                }
            };
        };

        // App Component
        const App = (props, context) => {
            MemoryTracker.increment('component');
            
            return {
                div: {
                    children: [
                        { RouteTable: {} }
                    ]
                },
                
                onUnmount: () => {
                    MemoryTracker.decrement('component');
                }
            };
        };

        // Initialize Juris with memory-conscious settings
        const juris = new Juris({
            logLevel: 'error', // Reduce logging overhead
            states: {
                tableData: generateTableData(50000), // Larger dataset for testing
                ui: {
                    table: {
                        scrollTop: 0,
                        selectedRows: [],
                        lastSelectedRow: null,
                        forceRefresh: 0,
                        columnWidths: {
                            id: 70,
                            action: 50,
                            oper: 80,
                            workArea: 100,
                            script: 120,
                            eMaxDelay: 90,
                            event: 150,
                            reworkOper: 100,
                            reworkRoute: 110,
                            returnOper: 100
                        }
                    }
                }
            },
            components: {
                App,
                RouteTable,
                VirtualContainer,
                TableRow,
                TableCell
            },
            layout: {
                App: {}
            }
        });

        juris.render('#app');
        
        // Initialize memory tracking
        MemoryTracker.updateDebugDisplay();
        
        // Expose for debugging
        window.juris = juris;
        window.MemoryTracker = MemoryTracker;
        
        // Optional: Set up periodic memory monitoring
        setInterval(() => {
            MemoryTracker.updateDebugDisplay();
        }, 1000);
        
        // Optional: Performance monitoring
        const logMemoryUsage = () => {
            if (performance.memory) {
                console.log('Memory Usage:', {
                    used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024) + 'MB',
                    total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024) + 'MB',
                    limit: Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024) + 'MB'
                });
            }
        };
        
        // Log memory usage every 5 seconds
        setInterval(logMemoryUsage, 5000);
    </script>
</body>
</html>