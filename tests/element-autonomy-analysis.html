<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exact Pattern Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-container { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .debug { background: #f0f0f0; padding: 10px; margin: 10px 0; font-family: monospace; font-size: 11px; }
        button { padding: 8px 16px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Exact Pattern Test - Your Original Code</h1>
    
    <div class="test-container">
        <button onclick="toggleTransparency()">Toggle Transparency</button>
        <button onclick="toggleTheme()">Toggle Theme</button>
        <button onclick="inspectAll()">Inspect All Styles</button>
    </div>

    <div class="test-container">
        <h3>Without CSSExtractor</h3>
        <div id="test1"></div>
        <div class="debug" id="debug1"></div>
    </div>

    <div class="test-container">
        <h3>With CSSExtractor</h3>
        <div id="test2"></div>
        <div class="debug" id="debug2"></div>
    </div>

    <script src="../src/juris-cssextractor.js"></script>
    <script src="../src/juris.0.9.0.js"></script>
    <script>
        // EXACT REPRODUCTION of your ResponsiveNav component structure
        function ResponsiveNav({ items }, { getState, setState }) {
            return {
                nav: {
                    style: {
                        // Container queries for responsive design
                        containerType: 'inline-size',
                        
                        // Base layout
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'space-between',
                        padding: 'clamp(0.5rem, 2vw, 1rem) clamp(1rem, 4vw, 2rem)',
                        
                        // EXACT REACTIVE STYLES FROM YOUR CODE
                        background: () => {
                            const opacity = getState('nav.transparency', 0.95);
                            const result = `color-mix(in srgb, red ${opacity * 100}%, transparent)`;
                            console.log(`Background function called: opacity=${opacity}, result=${result}`);
                            return result;
                        },
                        backdropFilter: 'blur(12px) saturate(1.2)',
                        borderBottom: '2px solid color-mix(in srgb, var(--border-color) 60%, transparent)',
                        position: 'sticky',
                        top: '10px',
                        zIndex: 1000,
                        
                        '@container (max-width: 768px)': {
                            flexDirection: 'column',
                            gap: '1rem',
                            padding: '1rem'
                        },
                        '--border-color': () => {
                            const color = getState('theme.borderColor', '#e2e8f0');
                            console.log(`Border color function called: ${color}`);
                            return color;
                        },
                        '--nav-height': 'clamp(60px, 8vh, 80px)'
                    },
                    children: [
                        {
                            div: {
                                // THIS IS THE EXACT PROBLEMATIC PATTERN
                                style: () => {
                                    console.log('Inner div style function called');
                                    return {
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: 'clamp(1rem, 3cqw, 2rem)',
                                        
                                        '@container (max-width: 768px)': {
                                            width: '100%',
                                            justifyContent: 'center'
                                        }
                                    };
                                },
                                children: items.map((item, index) => ({
                                    a: {
                                        href: item.href,
                                        style: {
                                            fontSize: 'clamp(0.875rem, 2.5cqw, 1rem)',
                                            fontWeight: '500',
                                            textDecoration: 'none',
                                            padding: '0.5rem 1rem',
                                            borderRadius: '0.5rem',
                                            
                                            color: () => {
                                                const color = getState('theme.linkColor', '#4a5568');
                                                console.log(`Link color function called: ${color}`);
                                                return color;
                                            },
                                            background: 'transparent',
                                            transition: 'all 0.2s ease',
                                            
                                            '&:hover': {
                                                background: 'blue',
                                                color: 'var(--link-hover-color)',
                                                transform: 'translateY(-1px)'
                                            },
                                            
                                            '--link-hover-color': () => {
                                                const color = getState('theme.linkHoverColor', 'red');
                                                console.log(`Link hover color function called: ${color}`);
                                                return color;
                                            },
                                            '--accent-color': () => {
                                                const color = getState('theme.accentColor', '#fd51bf');
                                                console.log(`Accent color function called: ${color}`);
                                                return color;
                                            }
                                        },
                                        text: item.label
                                    }
                                }))
                            }
                        }
                    ]
                }
            };
        }

        // Test 1: Without CSSExtractor
        const juris1 = new Juris({
            states: {
                nav: { transparency: 0.80 },
                theme: {
                    accentColor: 'pink',
                    linkColor: '#333',
                    borderColor: 'blue',
                    linkHoverColor: 'orange'
                }
            },
            components: { ResponsiveNav },
            layout: {
                ResponsiveNav: {
                    items: [
                        { href: 'google.com', label: 'Google' },
                        { href: 'yahoo.com', label: 'Yahoo' }
                    ]
                }
            }
        });

        // Test 2: With CSSExtractor
        const juris2 = new Juris({
            features: { cssExtract: CSSExtractor },
            states: {
                nav: { transparency: 0.80 },
                theme: {
                    accentColor: 'pink',
                    linkColor: '#333',
                    borderColor: 'blue',
                    linkHoverColor: 'orange'
                }
            },
            components: { ResponsiveNav },
            layout: {
                ResponsiveNav: {
                    items: [
                        { href: 'google.com', label: 'Google' },
                        { href: 'yahoo.com', label: 'Yahoo' }
                    ]
                }
            }
        });

        console.log('=== Rendering test1 (no CSSExtractor) ===');
        juris1.render('#test1');

        console.log('=== Rendering test2 (with CSSExtractor) ===');
        juris2.render('#test2');

        function toggleTransparency() {
            console.log('=== TOGGLE TRANSPARENCY ===');
            
            const current1 = juris1.getState('nav.transparency');
            const current2 = juris2.getState('nav.transparency');
            
            const new1 = current1 === 0.8 ? 0.5 : 0.8;
            const new2 = current2 === 0.8 ? 0.5 : 0.8;
            
            console.log(`Transparency: test1 ${current1}->${new1}, test2 ${current2}->${new2}`);
            
            juris1.setState('nav.transparency', new1);
            juris2.setState('nav.transparency', new2);
            
            setTimeout(inspectAll, 100);
        }

        function toggleTheme() {
            console.log('=== TOGGLE THEME ===');
            
            const current1 = juris1.getState('theme.linkColor');
            const current2 = juris2.getState('theme.linkColor');
            
            const new1 = current1 === '#333' ? '#fff' : '#333';
            const new2 = current2 === '#333' ? '#fff' : '#333';
            
            console.log(`Link color: test1 ${current1}->${new1}, test2 ${current2}->${new2}`);
            
            juris1.setState('theme.linkColor', new1);
            juris2.setState('theme.linkColor', new2);
            
            setTimeout(inspectAll, 100);
        }

        function inspectAll() {
            console.log('=== INSPECTING ALL STYLES ===');
            
            const nav1 = document.querySelector('#test1 nav');
            const nav2 = document.querySelector('#test2 nav');
            const div1 = document.querySelector('#test1 nav > div');
            const div2 = document.querySelector('#test2 nav > div');
            const link1 = document.querySelector('#test1 nav a');
            const link2 = document.querySelector('#test2 nav a');
            
            if (nav1 && nav2) {
                const navStyles1 = window.getComputedStyle(nav1);
                const navStyles2 = window.getComputedStyle(nav2);
                
                console.log('Nav background test1:', navStyles1.background);
                console.log('Nav background test2:', navStyles2.background);
                
                document.getElementById('debug1').innerHTML = `
Nav background: ${navStyles1.background}<br>
Nav border-color var: ${navStyles1.getPropertyValue('--border-color')}<br>
Div gap: ${div1 ? window.getComputedStyle(div1).gap : 'N/A'}<br>
Link color: ${link1 ? window.getComputedStyle(link1).color : 'N/A'}<br>
Link hover-color var: ${link1 ? window.getComputedStyle(link1).getPropertyValue('--link-hover-color') : 'N/A'}
                `;
                
                document.getElementById('debug2').innerHTML = `
Nav background: ${navStyles2.background}<br>
Nav border-color var: ${navStyles2.getPropertyValue('--border-color')}<br>
Div gap: ${div2 ? window.getComputedStyle(div2).gap : 'N/A'}<br>
Link color: ${link2 ? window.getComputedStyle(link2).color : 'N/A'}<br>
Link hover-color var: ${link2 ? window.getComputedStyle(link2).getPropertyValue('--link-hover-color') : 'N/A'}
                `;
            }
        }

        setTimeout(inspectAll, 500);
    </script>
</body>
</html>