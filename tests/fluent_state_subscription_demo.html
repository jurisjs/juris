<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FluentState Subscription Demo - Fixed Analytics</title>
    <script src="../src/juris.0.9.0.js"></script>
    <script src="../src/juris-headless.js"></script>
    <script src="../src/juris-fluentstate.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            color: white;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .demo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .demo-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .demo-card:hover {
            transform: translateY(-5px);
        }

        .demo-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .demo-description {
            color: #666;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .input-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .form-control {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .log-container {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.75rem;
            max-height: 200px;
            overflow-y: auto;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 0.25rem;
            padding: 0.25rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-timestamp {
            color: #a0aec0;
            font-size: 0.7rem;
        }

        .log-event {
            color: #68d391;
            font-weight: 600;
        }

        .log-path {
            color: #90cdf4;
        }

        .log-value {
            color: #fbb6ce;
        }

        .status-display {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: white;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .status-item:last-child {
            margin-bottom: 0;
        }

        .status-label {
            font-weight: 600;
            color: #495057;
        }

        .status-value {
            font-family: monospace;
            color: #667eea;
            font-weight: 600;
        }

        .subscription-list {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 1rem;
            max-height: 150px;
            overflow-y: auto;
        }

        .subscription-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: white;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
        }

        .subscription-item:last-child {
            margin-bottom: 0;
        }

        .subscription-path {
            font-family: monospace;
            color: #667eea;
            font-weight: 600;
        }

        .subscription-id {
            color: #6c757d;
            font-size: 0.7rem;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #cce7ff;
            color: #004085;
        }

        .counter-display {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            text-align: center;
            margin: 1rem 0;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .user-info h4 {
            margin-bottom: 0.25rem;
            color: #2d3748;
        }

        .user-info p {
            color: #6c757d;
            font-size: 0.875rem;
            margin: 0;
        }

        .todo-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .todo-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .todo-text {
            flex: 1;
            font-size: 0.875rem;
        }

        .todo-item.completed .todo-text {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .analytics-panel {
            background: #2d3748;
            color: white;
            border-radius: 12px;
            padding: 2rem;
            grid-column: 1 / -1;
        }

        .analytics-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-align: center;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .analytics-item {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .analytics-value {
            font-size: 2rem;
            font-weight: 700;
            color: #68d391;
        }

        .analytics-label {
            font-size: 0.875rem;
            color: #a0aec0;
            margin-top: 0.25rem;
        }

        @media (max-width: 768px) {
            .demo-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>
    
    <script>
        // ===================================================================
        // EXTERNAL ANALYTICS SYSTEM (NO FLUENTSTATE USAGE)
        // ===================================================================
        
        let logCounter = 0;
        const subscriptionHandles = new Map();
        
        // Wrapper for subscribe that tracks subscriptions
        function trackingSubscribe($, path, callback, options = {}) {
            // Get the actual subscription function
            let subscribeMethod;
            if (path === '') {
                // Root subscription
                subscribeMethod = $.subscribe;
            } else {
                // Navigate to the path and get subscribe method
                const pathParts = path.split('.');
                let current = $;
                for (const part of pathParts) {
                    current = current[part];
                }
                subscribeMethod = current.subscribe;
            }
            
            const unsubscribe = subscribeMethod.call(current || $, callback, options);
            
            const id = `tracked_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            subscriptionHandles.set(id, unsubscribe);
            
            console.log(`📡 Tracked subscription: ${path} (${id})`);
            updateAnalytics('Subscription Created', path, { id });
            
            return () => {
                unsubscribe();
                subscriptionHandles.delete(id);
                console.log(`📡 Tracked unsubscribe: ${path} (${id})`);
                updateAnalytics('Subscription Removed', path, { id });
            };
        }
        
        // Analytics that uses Juris directly, NOT FluentState
        function updateAnalytics(event, path, data = {}) {
            const context = app.createContext();
            const juris = context.juris;
            
            const logEntry = {
                id: ++logCounter,
                timestamp: new Date().toLocaleTimeString(),
                event,
                path,
                data
            };
            
            // Use Juris directly to avoid FluentState recursion
            const currentLogs = juris.getState('logs') || [];
            const newLogs = [...currentLogs, logEntry];
            
            // Keep only last 50 logs
            const trimmedLogs = newLogs.slice(-50);
            juris.setState('logs', trimmedLogs);
            
            // Update analytics using Juris directly
            const analytics = juris.getState('analytics') || {};
            const updatedAnalytics = { ...analytics };
            
            updatedAnalytics.totalCallbacks = (analytics.totalCallbacks || 0) + 1;
            
            if (event.includes('Deep')) {
                updatedAnalytics.deepWatches = (analytics.deepWatches || 0) + 1;
            }
            if (event === 'State Changed') {
                updatedAnalytics.stateChanges = (analytics.stateChanges || 0) + 1;
            }
            if (event === 'Subscription Created') {
                updatedAnalytics.subscriptionEvents = (analytics.subscriptionEvents || 0) + 1;
            }
            
            juris.setState('analytics', updatedAnalytics);
        }

        // ===================================================================
        // SUBSCRIPTION DEMO APPLICATION
        // ===================================================================
        
        const app = new Juris({
            states: {
                // Basic Counter Demo
                counter: 0,
                
                // User Profile Demo
                user: {
                    name: 'John Doe',
                    email: 'john@example.com',
                    role: 'Developer',
                    avatar: 'JD',
                    preferences: {
                        theme: 'light',
                        notifications: true
                    }
                },
                
                // Todo List Demo
                todos: [
                    { id: 1, text: 'Learn FluentState subscriptions', completed: false },
                    { id: 2, text: 'Build reactive applications', completed: false },
                    { id: 3, text: 'Master Juris framework', completed: true }
                ],
                nextTodoId: 4,
                newTodoText: '',
                
                // Shopping Cart Demo
                cart: {
                    items: [],
                    total: 0,
                    discount: 0
                },
                
                // Analytics Data
                analytics: {
                    subscriptionEvents: 0,
                    stateChanges: 0,
                    deepWatches: 0,
                    totalCallbacks: 0
                },
                
                // Log System
                logs: []
            },

            features: {
                headless: HeadlessManager
            },
            
            headlessComponents: {
                fluentState: {
                    fn: createFluentStateHeadless,
                    options: { autoInit: true }
                }
            },
            
            layout: { SubscriptionDemo: {} }
        });

        // ===================================================================
        // SETUP EXTERNAL STATE CHANGE MONITORING
        // ===================================================================
        
        setTimeout(() => {
            const { fluentState: { $ } } = app.createContext();
            
            // Monitor ALL state changes (except analytics and logs to avoid recursion)
            const globalStateSubscription = $.subscribe((state, oldState, path) => {
                // Skip analytics and logs paths to prevent recursion
                if (path && (path.startsWith('analytics.') || path.startsWith('logs.'))) {
                    return;
                }
                
                console.log(`🔍 Global state change detected: ${path}`);
                updateAnalytics('State Changed', path || 'root', { newValue: state, oldValue: oldState });
            }, { deep: true });
            
            subscriptionHandles.set('global-monitor', globalStateSubscription);
            
            console.log('✅ External analytics monitoring setup complete');
        }, 100);

        // ===================================================================
        // MAIN DEMO COMPONENT
        // ===================================================================
        
        app.registerComponent('SubscriptionDemo', (props, context) => {
            const { fluentState: { $ } } = context;
            
            return {
                div: {
                    className: 'container',
                    children: [
                        // Header
                        {
                            div: {
                                className: 'header',
                                children: [
                                    {
                                        h1: { text: '🔥 FluentState Subscriptions Fixed!' }
                                    },
                                    {
                                        p: { text: 'External analytics monitoring - No more recursion!' }
                                    }
                                ]
                            }
                        },

                        // Demo Grid
                        {
                            div: {
                                className: 'demo-grid',
                                children: [
                                    // Counter Demo
                                    { CounterDemo: {} },
                                    
                                    // User Profile Demo
                                    { UserProfileDemo: {} },
                                    
                                    // Todo List Demo
                                    { TodoDemo: {} },
                                    
                                    // Shopping Cart Demo
                                    { ShoppingCartDemo: {} },
                                    
                                    // Event Log
                                    { EventLog: {} }
                                ]
                            }
                        },

                        // Analytics Panel
                        { AnalyticsPanel: {} }
                    ]
                }
            };
        });

        // ===================================================================
        // COUNTER DEMO
        // ===================================================================
        
        app.registerComponent('CounterDemo', (props, context) => {
            const { fluentState: { $ } } = context;
            
            // Set up subscriptions on component mount
            setTimeout(() => {
                // Basic subscription using $.counter.subscribe directly
                const unsubscribe1 = $.counter.subscribe((value, oldValue, path) => {
                    updateAnalytics('Counter Changed', path, { value, oldValue });
                });
                subscriptionHandles.set('counter-basic', unsubscribe1);
                
                // Immediate subscription
                const unsubscribe2 = $.counter.subscribe((value) => {
                    updateAnalytics('Counter Immediate', 'counter', { value });
                }, { immediate: true });
                subscriptionHandles.set('counter-immediate', unsubscribe2);
                
                updateAnalytics('Subscription Created', 'counter', { type: 'basic + immediate' });
            }, 100);
            
            return {
                div: {
                    className: 'demo-card',
                    children: [
                        {
                            div: {
                                className: 'demo-title',
                                children: [
                                    { span: { text: '🔢' } },
                                    { span: { text: 'Counter Subscription' } }
                                ]
                            }
                        },
                        {
                            p: {
                                className: 'demo-description',
                                text: 'Basic subscription watching counter changes with immediate callback'
                            }
                        },
                        {
                            div: {
                                className: 'counter-display',
                                text: () => $.counter
                            }
                        },
                        {
                            div: {
                                className: 'controls',
                                children: [
                                    {
                                        button: {
                                            className: 'btn btn-primary',
                                            text: '+ Increment',
                                            onclick: () => { $.counter = $.counter + 1; }
                                        }
                                    },
                                    {
                                        button: {
                                            className: 'btn btn-secondary',
                                            text: '- Decrement',
                                            onclick: () => { $.counter = $.counter - 1; }
                                        }
                                    },
                                    {
                                        button: {
                                            className: 'btn btn-danger',
                                            text: '🔄 Reset',
                                            onclick: () => { $.counter = 0; }
                                        }
                                    }
                                ]
                            }
                        }
                    ]
                }
            };
        });

        // ===================================================================
        // USER PROFILE DEMO
        // ===================================================================
        
        app.registerComponent('UserProfileDemo', (props, context) => {
            const { fluentState: { $ } } = context;
            
            // Set up deep subscription
            setTimeout(() => {
                const unsubscribe = $.user.subscribe((user, oldUser, path) => {
                    updateAnalytics('User Deep Watch', path, { user });
                }, { deep: true });
                subscriptionHandles.set('user-deep', unsubscribe);
                
                // Specific preferences subscription
                const unsubscribe2 = $.user.preferences.subscribe((prefs, oldPrefs, path) => {
                    updateAnalytics('Preferences Changed', path, { prefs, oldPrefs });
                });
                subscriptionHandles.set('user-prefs', unsubscribe2);
                
                updateAnalytics('Subscription Created', 'user', { type: 'deep + preferences' });
            }, 150);
            
            return {
                div: {
                    className: 'demo-card',
                    children: [
                        {
                            div: {
                                className: 'demo-title',
                                children: [
                                    { span: { text: '👤' } },
                                    { span: { text: 'Deep Object Watching' } }
                                ]
                            }
                        },
                        {
                            p: {
                                className: 'demo-description',
                                text: 'Deep subscription watching nested user object changes'
                            }
                        },
                        {
                            div: {
                                className: 'user-profile',
                                children: [
                                    {
                                        div: {
                                            className: 'user-avatar',
                                            text: () => $.user.avatar
                                        }
                                    },
                                    {
                                        div: {
                                            className: 'user-info',
                                            children: [
                                                {
                                                    h4: { text: () => $.user.name }
                                                },
                                                {
                                                    p: { text: () => `${$.user.email} • ${$.user.role}` }
                                                },
                                                {
                                                    p: { text: () => `Theme: ${$.user.preferences.theme} • Notifications: ${$.user.preferences.notifications ? 'On' : 'Off'}` }
                                                }
                                            ]
                                        }
                                    }
                                ]
                            }
                        },
                        {
                            div: {
                                className: 'controls',
                                children: [
                                    {
                                        button: {
                                            className: 'btn btn-primary',
                                            text: '👤 Change Name',
                                            onclick: () => {
                                                const names = ['John Doe', 'Jane Smith', 'Bob Johnson', 'Alice Brown'];
                                                $.user.name = names[Math.floor(Math.random() * names.length)];
                                                $.user.avatar = $.user.name.split(' ').map(n => n[0]).join('');
                                            }
                                        }
                                    },
                                    {
                                        button: {
                                            className: 'btn btn-secondary',
                                            text: '🌓 Toggle Theme',
                                            onclick: () => {
                                                $.user.preferences.theme = $.user.preferences.theme === 'light' ? 'dark' : 'light';
                                            }
                                        }
                                    },
                                    {
                                        button: {
                                            className: 'btn btn-success',
                                            text: '🔔 Toggle Notifications',
                                            onclick: () => {
                                                $.user.preferences.notifications = !$.user.preferences.notifications;
                                            }
                                        }
                                    }
                                ]
                            }
                        }
                    ]
                }
            };
        });

        // ===================================================================
        // TODO DEMO
        // ===================================================================
        
        app.registerComponent('TodoDemo', (props, context) => {
            const { fluentState: { $ } } = context;
            
            // Set up todo subscriptions
            setTimeout(() => {
                const unsubscribe = $.todos.subscribe((todos, oldTodos, path) => {
                    const completedCount = todos.filter(t => t.completed).length;
                    updateAnalytics('Todos Changed', path, { 
                        total: todos.length, 
                        completed: completedCount,
                        remaining: todos.length - completedCount
                    });
                }, { deep: true });
                subscriptionHandles.set('todos-array', unsubscribe);
                
                updateAnalytics('Subscription Created', 'todos', { type: 'array deep watch' });
            }, 200);
            
            const addTodo = () => {
                if (!$.newTodoText.trim()) return;
                
                $.todos.push({
                    id: $.nextTodoId,
                    text: $.newTodoText,
                    completed: false
                });
                $.nextTodoId = $.nextTodoId + 1;
                $.newTodoText = '';
            };
            
            const toggleTodo = (id) => {
                const todos = $.x.todos.filterBy(t => t);
                const index = todos.findIndex(t => t.id === id);
                if (index !== -1) {
                    $.todos[index].completed = !$.todos[index].completed;
                }
            };
            
            return {
                div: {
                    className: 'demo-card',
                    children: [
                        {
                            div: {
                                className: 'demo-title',
                                children: [
                                    { span: { text: '✅' } },
                                    { span: { text: 'Array Deep Watching' } }
                                ]
                            }
                        },
                        {
                            p: {
                                className: 'demo-description',
                                text: 'Deep subscription watching array changes and nested object properties'
                            }
                        },
                        {
                            div: {
                                className: 'input-group',
                                children: [
                                    {
                                        input: {
                                            type: 'text',
                                            className: 'form-control',
                                            placeholder: 'Add new todo...',
                                            value: () => $.newTodoText,
                                            oninput: (e) => { $.newTodoText = e.target.value; },
                                            onkeypress: (e) => {
                                                if (e.key === 'Enter') addTodo();
                                            }
                                        }
                                    },
                                    {
                                        button: {
                                            className: 'btn btn-primary',
                                            text: '+ Add',
                                            onclick: addTodo
                                        }
                                    }
                                ]
                            }
                        },
                        {
                            div: {
                                children: () => {
                                    const todos = $.todos.filterBy(t => t);
                                    return todos.map(todo => ({
                                        div: {
                                            className: `todo-item ${todo.completed ? 'completed' : ''}`,
                                            children: [
                                                {
                                                    input: {
                                                        type: 'checkbox',
                                                        className: 'todo-checkbox',
                                                        checked: todo.completed,
                                                        onchange: () => toggleTodo(todo.id)
                                                    }
                                                },
                                                {
                                                    span: {
                                                        className: 'todo-text',
                                                        text: todo.text
                                                    }
                                                }
                                            ]
                                        }
                                    }));
                                }
                            }
                        }
                    ]
                }
            };
        });

        // ===================================================================
        // SHOPPING CART DEMO
        // ===================================================================
        
        app.registerComponent('ShoppingCartDemo', (props, context) => {
            const { fluentState: { $ } } = context;
            
            // Set up cart subscriptions
            setTimeout(() => {
                const unsubscribe = $.cart.subscribe((cart, oldCart, path) => {
                    updateAnalytics('Cart Updated', path, { 
                        items: cart.items?.length || 0,
                        total: cart.total,
                        discount: cart.discount
                    });
                }, { deep: true, immediate: true });
                subscriptionHandles.set('cart-watch', unsubscribe);
                
                updateAnalytics('Subscription Created', 'cart', { type: 'cart deep watch' });
            }, 250);
            
            const addItem = () => {
                const items = ['Laptop', 'Mouse', 'Keyboard', 'Monitor', 'Headphones'];
                const prices = [999, 25, 75, 299, 149];
                const randomIndex = Math.floor(Math.random() * items.length);
                
                $.cart.items.push({
                    id: Date.now(),
                    name: items[randomIndex],
                    price: prices[randomIndex],
                    quantity: 1
                });
                
                updateCartTotal();
            };
            
            const updateCartTotal = () => {
                const items = $.x.cart.items.filterBy(i => i) || [];
                const subtotal = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                $.cart.total = subtotal - $.cart.discount;
            };
            
            const applyDiscount = () => {
                $.cart.discount = Math.floor(Math.random() * 50) + 10;
                updateCartTotal();
            };
            
            return {
                div: {
                    className: 'demo-card',
                    children: [
                        {
                            div: {
                                className: 'demo-title',
                                children: [
                                    { span: { text: '🛒' } },
                                    { span: { text: 'Shopping Cart Watch' } }
                                ]
                            }
                        },
                        {
                            p: {
                                className: 'demo-description',
                                text: 'Complex nested object subscription with calculated values'
                            }
                        },
                        {
                            div: {
                                className: 'status-display',
                                children: [
                                    {
                                        div: {
                                            className: 'status-item',
                                            children: [
                                                {
                                                    span: {
                                                        className: 'status-label',
                                                        text: 'Items:'
                                                    }
                                                },
                                                {
                                                    span: {
                                                        className: 'status-value',
                                                        text: () => $.cart.items.getLength()
                                                    }
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        div: {
                                            className: 'status-item',
                                            children: [
                                                {
                                                    span: {
                                                        className: 'status-label',
                                                        text: 'Total:'
                                                    }
                                                },
                                                {
                                                    span: {
                                                        className: 'status-value',
                                                        text: () => `$${$.cart.total}`
                                                    }
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        div: {
                                            className: 'status-item',
                                            children: [
                                                {
                                                    span: {
                                                        className: 'status-label',
                                                        text: 'Discount:'
                                                    }
                                                },
                                                {
                                                    span: {
                                                        className: 'status-value',
                                                        text: () => `$${$.cart.discount}`
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                ]
                            }
                        },
                        {
                            div: {
                                className: 'controls',
                                children: [
                                    {
                                        button: {
                                            className: 'btn btn-primary',
                                            text: '🛍️ Add Item',
                                            onclick: addItem
                                        }
                                    },
                                    {
                                        button: {
                                            className: 'btn btn-success',
                                            text: '💰 Apply Discount',
                                            onclick: applyDiscount
                                        }
                                    },
                                    {
                                        button: {
                                            className: 'btn btn-danger',
                                            text: '🗑️ Clear Cart',
                                            onclick: () => {
                                                $.cart.items = [];
                                                $.cart.total = 0;
                                                $.cart.discount = 0;
                                            }
                                        }
                                    }
                                ]
                            }
                        }
                    ]
                }
            };
        });

        // ===================================================================
        // SUBSCRIPTION MANAGER
        // ===================================================================
        
        app.registerComponent('SubscriptionManager', (props, context) => {
            const { fluentState: { $ } } = context;
            
            const clearAllSubscriptions = () => {
                subscriptionHandles.forEach((unsubscribe, id) => {
                    try {
                        unsubscribe();
                        updateAnalytics('Subscription Removed', id, {});
                    } catch (error) {
                        console.error('Error removing subscription:', error);
                    }
                });
                subscriptionHandles.clear();
            };
            
            return {
                div: {
                    className: 'demo-card',
                    children: [
                        {
                            div: {
                                className: 'demo-title',
                                children: [
                                    { span: { text: '📡' } },
                                    { span: { text: 'Active Subscriptions' } }
                                ]
                            }
                        },
                        {
                            p: {
                                className: 'demo-description',
                                text: 'Manage and monitor all active FluentState subscriptions'
                            }
                        },
                        {
                            div: {
                                className: 'subscription-list',
                                children: () => {
                                    const subscriptions = Array.from(subscriptionHandles.keys());
                                    if (subscriptions.length === 0) {
                                        return [{
                                            div: {
                                                style: { textAlign: 'center', color: '#6c757d', padding: '1rem' },
                                                text: 'No active subscriptions'
                                            }
                                        }];
                                    }
                                    
                                    return subscriptions.map(id => ({
                                        div: {
                                            className: 'subscription-item',
                                            children: [
                                                {
                                                    span: {
                                                        className: 'subscription-path',
                                                        text: id
                                                    }
                                                },
                                                {
                                                    span: {
                                                        className: 'badge badge-success',
                                                        text: 'Active'
                                                    }
                                                }
                                            ]
                                        }
                                    }));
                                }
                            }
                        },
                        {
                            div: {
                                className: 'controls',
                                children: [
                                    {
                                        button: {
                                            className: 'btn btn-secondary',
                                            text: '📊 Debug Info',
                                            onclick: () => {
                                                console.log('Subscription Handles:', subscriptionHandles);
                                                console.log('FluentState Debug:', $.debug.getStats());
                                                updateAnalytics('Debug Info', 'console', { 
                                                    handles: subscriptionHandles.size,
                                                    stats: $.debug.getStats()
                                                });
                                            }
                                        }
                                    },
                                    {
                                        button: {
                                            className: 'btn btn-danger',
                                            text: '🧹 Clear All',
                                            onclick: clearAllSubscriptions
                                        }
                                    }
                                ]
                            }
                        }
                    ]
                }
            };
        });

        // ===================================================================
        // EVENT LOG
        // ===================================================================
        
        app.registerComponent('EventLog', (props, context) => {
            const { fluentState: { $ } } = context;
            
            return {
                div: {
                    className: 'demo-card',
                    children: [
                        {
                            div: {
                                className: 'demo-title',
                                children: [
                                    { span: { text: '📋' } },
                                    { span: { text: 'Event Log' } }
                                ]
                            }
                        },
                        {
                            p: {
                                className: 'demo-description',
                                text: 'Real-time log of all subscription events and state changes'
                            }
                        },
                        {
                            div: {
                                className: 'log-container',
                                children: () => {
                                    const logs = $.logs.filterBy(l => l).slice(-20).reverse();
                                    
                                    if (logs.length === 0) {
                                        return [{
                                            div: {
                                                style: { textAlign: 'center', color: '#a0aec0', padding: '1rem' },
                                                text: 'No events yet...'
                                            }
                                        }];
                                    }
                                    
                                    return logs.map(log => ({
                                        div: {
                                            className: 'log-entry',
                                            children: [
                                                {
                                                    div: {
                                                        children: [
                                                            {
                                                                span: {
                                                                    className: 'log-timestamp',
                                                                    text: log.timestamp
                                                                }
                                                            },
                                                            {
                                                                span: {
                                                                    text: ' - '
                                                                }
                                                            },
                                                            {
                                                                span: {
                                                                    className: 'log-event',
                                                                    text: log.event
                                                                }
                                                            },
                                                            {
                                                                span: {
                                                                    text: ' at '
                                                                }
                                                            },
                                                            {
                                                                span: {
                                                                    className: 'log-path',
                                                                    text: log.path
                                                                }
                                                            }
                                                        ]
                                                    }
                                                },
                                                {
                                                    div: {
                                                        className: 'log-value',
                                                        text: JSON.stringify(log.data, null, 2)
                                                    }
                                                }
                                            ]
                                        }
                                    }));
                                }
                            }
                        },
                        {
                            div: {
                                className: 'controls',
                                children: [
                                    {
                                        button: {
                                            className: 'btn btn-secondary',
                                            text: '🧹 Clear Log',
                                            onclick: () => { $.logs = []; }
                                        }
                                    }
                                ]
                            }
                        }
                    ]
                }
            };
        });

        // ===================================================================
        // ANALYTICS PANEL
        // ===================================================================
        
        app.registerComponent('AnalyticsPanel', (props, context) => {
            const { fluentState: { $ } } = context;
            
            return {
                div: {
                    className: 'analytics-panel',
                    children: [
                        {
                            h2: {
                                className: 'analytics-title',
                                text: '📊 Real-Time Analytics (Fixed!)'
                            }
                        },
                        {
                            div: {
                                className: 'analytics-grid',
                                children: [
                                    {
                                        div: {
                                            className: 'analytics-item',
                                            children: [
                                                {
                                                    div: {
                                                        className: 'analytics-value',
                                                        text: () => $.analytics.totalCallbacks
                                                    }
                                                },
                                                {
                                                    div: {
                                                        className: 'analytics-label',
                                                        text: 'Total Callbacks'
                                                    }
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        div: {
                                            className: 'analytics-item',
                                            children: [
                                                {
                                                    div: {
                                                        className: 'analytics-value',
                                                        text: () => $.analytics.subscriptionEvents
                                                    }
                                                },
                                                {
                                                    div: {
                                                        className: 'analytics-label',
                                                        text: 'Subscriptions Created'
                                                    }
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        div: {
                                            className: 'analytics-item',
                                            children: [
                                                {
                                                    div: {
                                                        className: 'analytics-value',
                                                        text: () => $.analytics.deepWatches
                                                    }
                                                },
                                                {
                                                    div: {
                                                        className: 'analytics-label',
                                                        text: 'Deep Watch Events'
                                                    }
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        div: {
                                            className: 'analytics-item',
                                            children: [
                                                {
                                                    div: {
                                                        className: 'analytics-value',
                                                        text: () => $.logs.getLength()
                                                    }
                                                },
                                                {
                                                    div: {
                                                        className: 'analytics-label',
                                                        text: 'Log Entries'
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                ]
                            }
                        }
                    ]
                }
            };
        });

        // ===================================================================
        // APP STARTUP & CONSOLE SETUP
        // ===================================================================
        
        app.render('#app');

        // Expose for console debugging
        window.app = app;
        window.$ = app.createContext().fluentState?.$;
        window.subscriptionHandles = subscriptionHandles;

        console.log('🚀 Fixed FluentState Subscription Demo loaded!');
        console.log('\n✅ PROBLEM SOLVED:');
        console.log('   • No more recursion in analytics');
        console.log('   • External monitoring using Juris directly');
        console.log('   • FluentState stays pure and lightweight');
        console.log('\n🔥 New Architecture:');
        console.log('   • FluentState: Pure proxy system');
        console.log('   • External Analytics: Monitors via subscription');
        console.log('   • Separation of Concerns: No circular dependencies');
        console.log('\n📊 State Changes counter should work now!');
    </script>
</body>
</html>