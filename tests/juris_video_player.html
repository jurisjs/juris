<!doctype html>
<html>
    <head>
        <script src="../src/juris.0.9.0.js"></script>
        <style>
            body {
                margin: 0;
                padding: 0;
            }
            * {
                box-sizing: border-box;
            }
        </style>
    </head>
    <body>
        <div id="video"></div>
        <script type="module">
            const VideoPlayer = (p, c) => {
                const { setState } = c;
                let videoElement = null;
                
                return {
                    // Expose API for other components to use
                    api: {
                        play: () => {
                            if (videoElement) {
                                videoElement.play();
                                setState("video.playing", true);
                                return true;
                            }
                            return false;
                        },
                        pause: () => {
                            if (videoElement) {
                                videoElement.pause();
                                setState("video.playing", false);
                                return true;
                            }
                            return false;
                        },
                        toggle: () => {
                            if (!videoElement) return false;
                            
                            if (videoElement.paused) {
                                videoElement.play();
                                setState("video.playing", true);
                            } else {
                                videoElement.pause();
                                setState("video.playing", false);
                            }
                            return true;
                        },
                        getElement: () => videoElement,
                        getCurrentTime: () => videoElement?.currentTime || 0,
                        getDuration: () => videoElement?.duration || 0
                    },
                    
                    render: () => ({
                        div: {
                            children: [
                                {
                                    video: {
                                        text: "Video playback not supported",
                                        controls: true,
                                        autoplay: false,
                                        loop: true,
                                        style: {
                                            width: "100vw",
                                        },
                                        ref: (el) => {
                                            videoElement = el; // Store reference when element is created
                                        },
                                        onloadedmetadata: (e) => {
                                            console.log(
                                                `${e.target.videoWidth}x${e.target.videoHeight}`,
                                            );
                                        },
                                        onplay: (e) => {
                                            setState("video.playing", true);
                                        },
                                        onpause: (e) => {
                                            setState("video.playing", false);
                                        },
                                        onended: (e) => {
                                            setState("video.playing", false);
                                        },
                                        onerror: (e) => {
                                            console.error(e);
                                        },
                                        children: [
                                            {
                                                source: {
                                                    src: "https://download.samplelib.com/mp4/sample-5s.mp4",
                                                },
                                            },
                                            {
                                                source: {
                                                    src: "https://download.samplelib.com/mp4/sample-15s.mp4",
                                                },
                                            },
                                        ],
                                    },
                                },
                                {
                                    PlayButton: {},
                                },
                            ],
                        },
                    }),
                };
            };

            const PlayButton = (p, c) => {
                const { getState, juris } = c;
                
                return {
                    render: () => ({
                        button: {
                            text: () =>
                                getState("video.playing") ? "PAUSE" : "PLAY",
                            style: {
                                padding: "10px 20px",
                                margin: "10px",
                                fontSize: "16px",
                                backgroundColor: "#007bff",
                                color: "white",
                                border: "none",
                                borderRadius: "4px",
                                cursor: "pointer"
                            },
                            onclick: () => {
                                // Clean singleton component access by name
                                const videoAPI = juris.getComponentAPI('VideoPlayer');
                                
                                if (videoAPI) {
                                    console.log('✅ Clean API access working!');
                                    videoAPI.toggle();
                                } else {
                                    console.error('❌ Enhanced fix not applied');
                                }
                            },
                        },
                    }),
                };
            };

            // State-driven video manager for fallback control
            const VideoManager = (p, c) => {
                const { getState, subscribe } = c;
                
                // Subscribe to action state changes for fallback control
                subscribe("video.action", (newAction) => {
                    if (newAction) {
                        const videoElement = document.querySelector('video');
                        if (videoElement) {
                            if (newAction === "play") {
                                videoElement.play().catch(console.error);
                            } else if (newAction === "pause") {
                                videoElement.pause();
                            }
                            // Clear the action after processing
                            setTimeout(() => {
                                videoApp.stateManager.setState("video.action", null);
                            }, 100);
                        }
                    }
                });
                
                // This component has no render method - it's purely for state management
                return {
                    // No render method = headless functionality without HeadlessManager
                };
            };

            const videoApp = new Juris({
                state: {
                    video: {
                        playing: false,
                        action: null
                    },
                },
                components: {
                    PlayButton,
                    VideoPlayer,
                    VideoManager
                },
                layout: { 
                    VideoPlayer: {} // Only VideoPlayer in layout
                },
            });

            videoApp.render("#video");
            
            // Manually create VideoManager instance for state management
            const videoManagerContext = videoApp.createContext();
            VideoManager({}, videoManagerContext);
        </script>
    </body>
</html>