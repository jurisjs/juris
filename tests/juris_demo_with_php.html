<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juris APIClient Demo - Fixed</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .demo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            padding: 30px;
        }

        .demo-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 25px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .demo-section:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .demo-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c53030;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
            font-weight: 500;
        }

        .status-loading {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }

        .status-error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        .status-success {
            background: #e8f5e8;
            color: #2e7d2e;
            border: 1px solid #c8e6c9;
        }

        .status-cancelled {
            background: #fff3e0;
            color: #f57c00;
            border: 1px solid #ffcc02;
        }

        .results {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .user-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
        }

        .user-card h4 {
            color: #333;
            margin-bottom: 4px;
        }

        .user-card p {
            color: #666;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            padding: 10px 16px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab:hover {
            background: #f8f9fa;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        @media (max-width: 768px) {
            .demo-grid {
                grid-template-columns: 1fr;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Load Juris Framework -->
    <script src="../src/headless/juris-apiclient.js"></script>
    <script src="../src/juris-headless.js"></script>
    <script src="../src/juris.js"></script>
    
    <div id="app"></div>

    <script>
        // Smart Search Demo - Fixed version
        const SmartSearchDemo = (props, context) => {
            const apiClient = context.components.getHeadlessAPI('APIClient');
            const [query, setQuery] = context.newState('searchQuery', '');
            const [results, setResults] = context.newState('searchResults', null);
            const [searchState, setSearchState] = context.newState('searchState', 'idle');
            const [searchError, setSearchError] = context.newState('searchError', null);
            const [lastQuery, setLastQuery] = context.newState('lastQuery', '');
            
            let searchTimeout;
            
            const performSearch = (searchQuery) => {
                if (!searchQuery || searchQuery.length < 2) {
                    setResults(null);
                    setSearchState('idle');
                    return;
                }
                
                if (!apiClient) {
                    setSearchError('APIClient not available');
                    setSearchState('error');
                    return;
                }
                
                if (searchQuery === lastQuery()) {
                    return;
                }
                
                setLastQuery(searchQuery);
                setSearchState('loading');
                setSearchError(null);
                
                const request = apiClient.get(`./api.php?action=search&q=${encodeURIComponent(searchQuery)}`, {
                    group: 'search', 
                    cancelPrevious: true 
                });
                
                const checkResults = () => {
                    const { data, error, loading, cancelled } = request;
                    
                    if (cancelled()) {
                        setSearchState('cancelled');
                        return;
                    }
                    
                    if (loading()) {
                        setTimeout(checkResults, 50);
                        return;
                    }
                    
                    if (error()) {
                        setSearchError(error());
                        setSearchState('error');
                        return;
                    }
                    
                    if (data()) {
                        setResults(data());
                        setSearchState('success');
                        return;
                    }
                };
                
                setTimeout(checkResults, 50);
            };
            
            const handleInput = (e) => {
                const newQuery = e.target.value;
                setQuery(newQuery);
                
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                
                searchTimeout = setTimeout(() => {
                    performSearch(newQuery);
                }, 300);
            };
            
            return {
                div: {
                    className: 'demo-section',
                    children: [
                        {h3: {text: '🔍 Smart Search with Cancellation'}},
                        
                        {div: {
                            className: 'form-group',
                            children: [
                                {label: {text: 'Search Users:'}},
                                {input: {
                                    className: 'form-input',
                                    type: 'text',
                                    placeholder: 'Type to search users...',
                                    value: () => query(),
                                    oninput:(e)=> handleInput(e)
                                }}
                            ]
                        }},
                        
                        {div: {
                            children: () => {
                                const state = searchState();
                                const error = searchError();
                                
                                if (state === 'idle') {
                                    return {div: {className: 'status', text: 'Start typing to search...'}};
                                }
                                if (state === 'loading') {
                                    return {div: {className: 'status status-loading', text: 'Searching...'}};
                                }
                                if (state === 'error') {
                                    return {div: {className: 'status status-error', text: `Error: ${error}`}};
                                }
                                if (state === 'cancelled') {
                                    return {div: {className: 'status status-cancelled', text: 'Search cancelled'}};
                                }
                                if (state === 'success') {
                                    return {div: {className: 'status status-success', text: 'Search completed'}};
                                }
                                return null;
                            }
                        }},
                        
                        {div: {
                            className: 'results',
                            children: () => {
                                const searchResults = results();
                                
                                if (!searchResults) {
                                    return {div: {text: 'No results yet'}};
                                }
                                
                                if (searchResults.length === 0) {
                                    return {div: {text: 'No users found matching your search.'}};
                                }
                                
                                return {
                                    div: {
                                        children: searchResults.map(user => ({
                                            div: {
                                                className: 'user-card fade-in',
                                                children: [
                                                    {h4: {text: user.name}},
                                                    {p: {text: user.email}},
                                                    {p: {text: `Department: ${user.department}`}}
                                                ]
                                            }
                                        }))
                                    }
                                };
                            }
                        }}
                    ]
                }
            };
        };

        // CRUD Demo - Fixed version
        const CRUDDemo = (props, context) => {
            const apiClient = context.components.getHeadlessAPI('APIClient');
            const [users, setUsers] = context.newState('users', []);
            const [newUserName, setNewUserName] = context.newState('newUserName', '');
            const [newUserEmail, setNewUserEmail] = context.newState('newUserEmail', '');
            const [isLoading, setIsLoading] = context.newState('isLoading', false);
            const [isCreating, setIsCreating] = context.newState('isCreating', false);
            const [error, setError] = context.newState('error', null);
            
            const loadUsers = () => {
                if (!apiClient) {
                    setError('APIClient not available');
                    return;
                }
                
                setIsLoading(true);
                setError(null);
                
                const request = apiClient.get('./api.php?action=users', {
                    group: 'users',
                    cancelPrevious: true
                });
                
                const checkResult = () => {
                    const { data, error: apiError, loading } = request;
                    
                    if (!loading()) {
                        setIsLoading(false);
                        if (apiError()) {
                            setError(apiError());
                        } else if (data()) {
                            setUsers(data());
                            setError(null);
                        }
                    } else {
                        setTimeout(checkResult, 50);
                    }
                };
                
                checkResult();
            };
            
            const createUser = () => {
                if (!newUserName() || !newUserEmail()) return;
                if (!apiClient) {
                    setError('APIClient not available');
                    return;
                }
                
                setIsCreating(true);
                setError(null);
                
                const request = apiClient.post('./api.php?action=create', {
                    name: newUserName(),
                    email: newUserEmail(),
                    department: 'Engineering'
                }, {
                    group: 'createUser'
                });
                
                const checkResult = () => {
                    const { data, error: apiError, loading } = request;
                    
                    if (!loading()) {
                        setIsCreating(false);
                        if (apiError()) {
                            setError(apiError());
                        } else if (data()) {
                            setUsers([...users(), data()]);
                            setNewUserName('');
                            setNewUserEmail('');
                            setError(null);
                        }
                    } else {
                        setTimeout(checkResult, 50);
                    }
                };
                
                checkResult();
            };
            
            const deleteUser = (userId) => {
                if (!apiClient) {
                    setError('APIClient not available');
                    return;
                }
                
                const request = apiClient.delete(`./api.php?action=delete&id=${userId}`, {
                    group: `delete-${userId}`
                });
                
                const checkResult = () => {
                    const { data, error: apiError, loading } = request;
                    
                    if (!loading()) {
                        if (apiError()) {
                            setError(apiError());
                        } else if (data()) {
                            setUsers(users().filter(u => u.id !== userId));
                            setError(null);
                        }
                    } else {
                        setTimeout(checkResult, 50);
                    }
                };
                
                checkResult();
            };
            
            return {
                div: {
                    className: 'demo-section',
                    children: [
                        {h3: {text: '👥 User Management (CRUD)'}},
                        
                        {div: {
                            children: [
                                {button: {
                                    className: 'btn btn-primary',
                                    text: () => isLoading() ? 'Loading...' : 'Load Users',
                                    disabled: () => isLoading(),
                                    onclick: loadUsers
                                }},
                                () => error() ? {div: {className: 'status status-error', text: `Error: ${error()}`}} : null
                            ]
                        }},
                        
                        {div: {
                            style: {marginTop: '20px'},
                            children: [
                                {div: {
                                    className: 'form-group',
                                    children: [
                                        {label: {text: 'Name:'}},
                                        {input: {
                                            className: 'form-input',
                                            type: 'text',
                                            value: () => newUserName(),
                                            oninput: (e) => setNewUserName(e.target.value)
                                        }}
                                    ]
                                }},
                                {div: {
                                    className: 'form-group',
                                    children: [
                                        {label: {text: 'Email:'}},
                                        {input: {
                                            className: 'form-input',
                                            type: 'email',
                                            value: () => newUserEmail(),
                                            oninput: (e) => setNewUserEmail(e.target.value)
                                        }}
                                    ]
                                }},
                                {div: {
                                    children: [
                                        {button: {
                                            className: 'btn btn-primary',
                                            text: () => isCreating() ? 'Creating...' : 'Create User',
                                            disabled: () => isCreating() || !newUserName() || !newUserEmail(),
                                            onclick: createUser
                                        }}
                                    ]
                                }}
                            ]
                        }},
                        
                        {div: {
                            className: 'results',
                            children: () => {
                                const userList = users();
                                if (!userList || userList.length === 0) {
                                    return {div: {text: 'No users found. Click "Load Users" to fetch data.'}};
                                }
                                
                                return {
                                    div: {
                                        children: userList.map(user => ({
                                            div: {
                                                className: 'user-card fade-in',
                                                children: [
                                                    {h4: {text: user.name}},
                                                    {p: {text: user.email}},
                                                    {p: {text: `Department: ${user.department}`}},
                                                    {button: {
                                                        className: 'btn btn-danger',
                                                        text: 'Delete',
                                                        onclick: () => deleteUser(user.id)
                                                    }}
                                                ]
                                            }
                                        }))
                                    }
                                };
                            }
                        }}
                    ]
                }
            };
        };

        // Tab Demo - Fixed reactive subscriptions
        const TabDemo = (props, context) => {
            const apiClient = context.components.getHeadlessAPI('APIClient');
            const [activeTab, setActiveTab] = context.newState('activeTab', 'users');
            
            // Separate state for each tab
            const [usersData, setUsersData] = context.newState('usersData', null);
            const [usersState, setUsersState] = context.newState('usersState', 'idle');
            const [usersError, setUsersError] = context.newState('usersError', null);
            
            const [productsData, setProductsData] = context.newState('productsData', null);
            const [productsState, setProductsState] = context.newState('productsState', 'idle');
            const [productsError, setProductsError] = context.newState('productsError', null);
            
            const [ordersData, setOrdersData] = context.newState('ordersData', null);
            const [ordersState, setOrdersState] = context.newState('ordersState', 'idle');
            const [ordersError, setOrdersError] = context.newState('ordersError', null);
            
            const tabs = [
                { id: 'users', label: 'Users' },
                { id: 'products', label: 'Products' },
                { id: 'orders', label: 'Orders' }
            ];
            
            const getTabSetters = (tabId) => {
                switch (tabId) {
                    case 'users':
                        return { setData: setUsersData, setState: setUsersState, setError: setUsersError };
                    case 'products':
                        return { setData: setProductsData, setState: setProductsState, setError: setProductsError };
                    case 'orders':
                        return { setData: setOrdersData, setState: setOrdersState, setError: setOrdersError };
                    default:
                        return { setData: () => {}, setState: () => {}, setError: () => {} };
                }
            };
            
            const loadTabData = (tabId) => {
                if (!apiClient) {
                    const { setError, setState } = getTabSetters(tabId);
                    setError('APIClient not available');
                    setState('error');
                    return;
                }
                
                const { setData, setState, setError } = getTabSetters(tabId);
                
                setState('loading');
                setError(null);
                
                const request = apiClient.get(`./api.php?action=${tabId}`, {
                    group: `tab-${tabId}`,
                    cancelPrevious: true
                });
                
                const checkResults = () => {
                    const { data, error, loading, cancelled } = request;
                    
                    if (cancelled()) {
                        setState('cancelled');
                        return;
                    }
                    
                    if (loading()) {
                        setTimeout(checkResults, 50);
                        return;
                    }
                    
                    if (error()) {
                        setError(error());
                        setState('error');
                        return;
                    }
                    
                    if (data()) {
                        setData(data());
                        setState('success');
                        return;
                    }
                };
                
                setTimeout(checkResults, 50);
            };
            
            const switchTab = (newTab) => {
                if (apiClient) {
                    apiClient.cancelGroup(`tab-${activeTab()}`);
                }
                setActiveTab(newTab);
                loadTabData(newTab);
            };
            
            // Load initial tab data
            const current = activeTab();
            if (current === 'users' && usersState() === 'idle') loadTabData('users');
            if (current === 'products' && productsState() === 'idle') loadTabData('products');
            if (current === 'orders' && ordersState() === 'idle') loadTabData('orders');
            
            return {
                div: {
                    className: 'demo-section',
                    children: [
                        {h3: {text: '📋 Tabbed Data with Auto-Cancel'}},
                        
                        {div: {
                            className: 'tabs',
                            children: tabs.map(tab => ({
                                button: {
                                    className: () => `tab ${activeTab() === tab.id ? 'active' : ''}`,
                                    text: tab.label,
                                    onclick: () => switchTab(tab.id)
                                }
                            }))
                        }},
                        
                        {div: {
                            children: () => {
                                const currentTab = activeTab();
                                
                                // Now we can properly subscribe to individual state paths
                                let state, data, error;
                                
                                if (currentTab === 'users') {
                                    state = usersState();
                                    data = usersData();
                                    error = usersError();
                                } else if (currentTab === 'products') {
                                    state = productsState();
                                    data = productsData();
                                    error = productsError();
                                } else if (currentTab === 'orders') {
                                    state = ordersState();
                                    data = ordersData();
                                    error = ordersError();
                                }
                                
                                if (state === 'loading') {
                                    return {div: {className: 'status status-loading', text: `Loading ${currentTab}...`}};
                                }
                                if (state === 'cancelled') {
                                    return {div: {className: 'status status-cancelled', text: `${currentTab} request cancelled`}};
                                }
                                if (state === 'error') {
                                    return {div: {className: 'status status-error', text: `Error loading ${currentTab}: ${error}`}};
                                }
                                if (state === 'success') {
                                    if (!data || data.length === 0) {
                                        return {div: {className: 'status', text: `No ${currentTab} found`}};
                                    }
                                    
                                    return {
                                        div: {
                                            className: 'results',
                                            children: data.map(item => ({
                                                div: {
                                                    className: 'user-card fade-in',
                                                    children: [
                                                        {h4: {text: item.name || item.title}},
                                                        {p: {text: item.email || item.description || item.status}}
                                                    ]
                                                }
                                            }))
                                        }
                                    };
                                }
                                return {div: {className: 'status', text: 'Click to load data...'}};
                            }
                        }}
                    ]
                }
            };
        };

        // Cancel Controls Demo
        const CancelDemo = (props, context) => {
            const apiClient = context.components.getHeadlessAPI('APIClient');
            
            return {
                div: {
                    className: 'demo-section',
                    children: [
                        {h3: {text: '🛑 Cancellation Controls'}},
                        
                        {div: {
                            children: [
                                {button: {
                                    className: 'btn btn-primary',
                                    text: 'Start Long Request',
                                    onclick: () => {
                                        if (apiClient) {
                                            apiClient.get('./api.php?action=slow&delay=5', {
                                                group: 'slowRequest'
                                            });
                                        }
                                    }
                                }},
                                
                                {button: {
                                    className: 'btn btn-danger',
                                    text: 'Cancel Search Requests',
                                    onclick: () => {
                                        if (apiClient) {
                                            apiClient.cancelGroup('search');
                                        }
                                    }
                                }},
                                
                                {button: {
                                    className: 'btn btn-danger',
                                    text: 'Cancel All Tabs',
                                    onclick: () => {
                                        if (apiClient) {
                                            ['tab-users', 'tab-products', 'tab-orders'].forEach(group => {
                                                apiClient.cancelGroup(group);
                                            });
                                        }
                                    }
                                }},
                                
                                {button: {
                                    className: 'btn btn-danger',
                                    text: 'Cancel Everything',
                                    onclick: () => {
                                        if (apiClient) {
                                            apiClient.cancelAll();
                                        }
                                    }
                                }}
                            ]
                        }},
                        
                        {div: {
                            className: 'status',
                            style: {marginTop: '15px'},
                            text: 'Use these buttons to cancel requests from other demos. Notice how cancelled requests don\'t update the UI even if the response arrives later.'
                        }}
                    ]
                }
            };
        };

        // Main App
        const DemoApp = (props, context) => {
            return {
                div: {
                    className: 'container',
                    children: [
                        {div: {
                            className: 'header',
                            children: [
                                {h1: {text: 'Juris APIClient Demo'}},
                                {p: {text: 'Smart HTTP requests with cancellation and state management'}}
                            ]
                        }},
                        
                        {div: {
                            className: 'demo-grid',
                            children: [
                                {SmartSearchDemo: {}},
                                {CRUDDemo: {}},
                                {TabDemo: {}},
                                {CancelDemo: {}}
                            ]
                        }}
                    ]
                }
            };
        };

        // Initialize Juris
        const juris = new Juris({
            features: {
                headless: HeadlessManager
            },
            
            components: {
                DemoApp,
                SmartSearchDemo,
                CRUDDemo,
                TabDemo,
                CancelDemo
            },
            
            headlessComponents: {
                APIClient: {
                    fn: window.APIClient || APIClient,
                    options: {
                        baseURL: '',
                        defaultHeaders: {
                            'Content-Type': 'application/json'
                        },
                        timeout: 10000,
                        autoInit: true
                    }
                }
            },
            
            layout: {
                DemoApp: {}
            }
        });

        // Render the app
        juris.render('#app');
    </script>
</body>
</html>