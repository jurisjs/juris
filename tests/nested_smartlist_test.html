<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nested SmartList Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .demo-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .category-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin: 10px 0;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .category-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .category-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2d3748;
            margin: 0;
        }

        .category-count {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .todo-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #48bb78;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .todo-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .todo-item.done {
            opacity: 0.7;
            border-left-color: #a0aec0;
        }

        .todo-item.done span {
            text-decoration: line-through;
        }

        .todo-text {
            flex: 1;
            margin: 0 10px;
            font-size: 0.9em;
        }

        .priority-high { border-left-color: #f56565; }
        .priority-medium { border-left-color: #ed8936; }
        .priority-low { border-left-color: #48bb78; }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .debug-info {
            background: #2d3748;
            color: white;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            margin-top: 20px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .empty-state {
            text-align: center;
            padding: 20px;
            color: #718096;
            font-style: italic;
        }

        .move-buttons {
            display: flex;
            gap: 5px;
        }

        .move-btn {
            background: #4a5568;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .move-btn:hover {
            background: #2d3748;
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <h1>üîÑ Nested SmartList Test</h1>
        <p>Testing 2 levels: Categories ‚Üí Todo Items with cross-category item movement</p>
        
        <div class="controls">
            <button onclick="addRandomTodo()">‚ûï Add Random Todo</button>
            <button onclick="moveRandomTodo()">üîÄ Move Todo Between Categories</button>
            <button onclick="toggleRandomTodo()">‚úÖ Toggle Random Todo</button>
            <button onclick="shuffleCategories()">üîÑ Shuffle Categories</button>
            <button onclick="addCategory()">üìÅ Add Category</button>
            <button onclick="clearDebug()">üßπ Clear Debug</button>
        </div>
        
        <div id="app"></div>
        
        <div class="debug-info" id="debugInfo">Debug info will appear here...</div>
    </div>

    <script src="../src/juris.js"></script>
    <script src="../juris-ui/iterators/For.js"></script>
    <script>
        // Nested components
        const CategoryCard = (props, context) => {
          const { category } = props;
          
          return {
            div: {
              class: 'category-card',
              'data-category-id': category.id,
              children: [
                {
                  div: {
                    class: 'category-header',
                    children: [
                      {
                        h3: {
                          class: 'category-title',
                          text: category.name
                        }
                      },
                      {
                        span: {
                          class: 'category-count',
                          text: () => {
                            const categories = context.getState('categories', []);
                            const currentCategory = categories.find(cat => cat.id === category.id);
                            return `${currentCategory?.todos.length || 0} items`;
                          }
                        }
                      }
                    ]
                  }
                },
                {
                  SmartList: {
                    class: 'todos-list',
                    items: () => {
                      const categories = context.getState('categories', []);
                      const currentCategory = categories.find(cat => cat.id === category.id);
                      return currentCategory?.todos || [];
                    },
                    keyFn: (todo) => todo.id,
                    renderItem: (todo, index) => ({
                      TodoItem: { 
                        todoId: todo.id, 
                        categoryId: category.id 
                      }
                    }),
                    placeholder: {
                      div: {
                        class: 'empty-state',
                        text: 'No todos in this category'
                      }
                    }
                  }
                }
              ]
            }
          };
        };

        const TodoItem = (props, context) => {
          const { todoId, categoryId } = props;
          
          const getTodoData = () => {
            const categories = context.getState('categories', []);
            const category = categories.find(cat => cat.id === categoryId);
            return category?.todos.find(t => t.id === todoId);
          };
          
          return {
            div: {
              class: () => {
                const todo = getTodoData();
                if (!todo) return 'todo-item';
                const classes = ['todo-item'];
                if (todo.done) classes.push('done');
                classes.push(`priority-${todo.priority}`);
                return classes.join(' ');
              },
              'data-todo-id': todoId,
              children: [
                {
                  input: {
                    type: 'checkbox',
                    checked: () => {
                      const todo = getTodoData();
                      return todo?.done || false;
                    },
                    onchange: (e) => {
                      const categories = context.getState('categories', []);
                      const updatedCategories = categories.map(cat => {
                        if (cat.id === categoryId) {
                          return {
                            ...cat,
                            todos: cat.todos.map(t => 
                              t.id === todoId ? {...t, done: e.target.checked} : t
                            )
                          };
                        }
                        return cat;
                      });
                      context.setState('categories', updatedCategories);
                      logDebug(`Toggled todo ${todoId} in category ${categoryId}`);
                    }
                  }
                },
                {
                  span: {
                    class: 'todo-text',
                    text: () => {
                      const todo = getTodoData();
                      return todo ? `${todo.text} (${todo.priority})` : 'Loading...';
                    }
                  }
                },
                {
                  div: {
                    class: 'move-buttons',
                    children: [
                      {
                        button: {
                          class: 'move-btn',
                          text: '‚¨ÖÔ∏è',
                          onclick: () => moveTodoToCategory(todoId, categoryId, 'prev')
                        }
                      },
                      {
                        button: {
                          class: 'move-btn',
                          text: '‚û°Ô∏è',
                          onclick: () => moveTodoToCategory(todoId, categoryId, 'next')
                        }
                      }
                    ]
                  }
                }
              ]
            }
          };
        };

        // Initialize Juris
        const juris = new Juris({
          logLevel: 'debug',
          states: {
            categories: [
              {
                id: 1,
                name: 'Work',
                todos: [
                  { id: 1, text: 'Review code', done: false, priority: 'high' },
                  { id: 2, text: 'Write docs', done: true, priority: 'medium' },
                  { id: 3, text: 'Team meeting', done: false, priority: 'high' }
                ]
              },
              {
                id: 2,
                name: 'Personal',
                todos: [
                  { id: 4, text: 'Buy groceries', done: false, priority: 'low' },
                  { id: 5, text: 'Call mom', done: true, priority: 'medium' }
                ]
              },
              {
                id: 3,
                name: 'Learning',
                todos: [
                  { id: 6, text: 'Study React', done: false, priority: 'high' },
                  { id: 7, text: 'Practice algorithms', done: false, priority: 'medium' }
                ]
              }
            ],
            nextTodoId: 8,
            nextCategoryId: 4,
            debugLog: []
          }
        });

        // Register components
        juris.registerComponent('SmartList', SmartList);
        juris.registerComponent('CategoryCard', CategoryCard);
        juris.registerComponent('TodoItem', TodoItem);

        // Main App component
        const App = (props, context) => {
          return {
            div: {
              children: {
                SmartList: {
                  class: 'categories-list',
                  items: () => context.getState('categories', []),
                  keyFn: (category) => category.id,
                  renderItem: (category, index) => ({
                    CategoryCard: { category }
                  }),
                  placeholder: {
                    div: {
                      class: 'empty-state',
                      text: 'No categories yet'
                    }
                  }
                }
              }
            }
          };
        };

        juris.registerComponent('App', App);

        // Utility functions
        function logDebug(message) {
          const debugLog = juris.getState('debugLog', []);
          const timestamp = new Date().toLocaleTimeString();
          const newLog = [...debugLog, `[${timestamp}] ${message}`];
          
          // Keep only last 20 entries
          if (newLog.length > 20) {
            newLog.splice(0, newLog.length - 20);
          }
          
          juris.setState('debugLog', newLog);
          
          // Update debug display
          const debugInfo = document.getElementById('debugInfo');
          if (debugInfo) {
            debugInfo.textContent = newLog.join('\n');
            debugInfo.scrollTop = debugInfo.scrollHeight;
          }
        }

        function getRandomTodoText() {
          const texts = [
            'Fix bug in header', 'Update dependencies', 'Write unit tests',
            'Plan vacation', 'Read book', 'Exercise', 'Cook dinner',
            'Learn new framework', 'Practice coding', 'Watch tutorial'
          ];
          return texts[Math.floor(Math.random() * texts.length)];
        }

        function getRandomPriority() {
          const priorities = ['low', 'medium', 'high'];
          return priorities[Math.floor(Math.random() * priorities.length)];
        }

        // Global functions for button handlers
        window.addRandomTodo = function() {
          const categories = juris.getState('categories', []);
          const randomCategoryIndex = Math.floor(Math.random() * categories.length);
          const nextId = juris.getState('nextTodoId', 1);
          
          const updatedCategories = categories.map((cat, index) => {
            if (index === randomCategoryIndex) {
              return {
                ...cat,
                todos: [...cat.todos, {
                  id: nextId,
                  text: getRandomTodoText(),
                  done: false,
                  priority: getRandomPriority()
                }]
              };
            }
            return cat;
          });
          
          juris.setState('categories', updatedCategories);
          juris.setState('nextTodoId', nextId + 1);
          logDebug(`Added todo ${nextId} to category ${categories[randomCategoryIndex].name}`);
        };

        window.moveRandomTodo = function() {
          const categories = juris.getState('categories', []);
          
          // Find all todos
          const allTodos = [];
          categories.forEach((cat, catIndex) => {
            cat.todos.forEach(todo => {
              allTodos.push({ todo, categoryIndex: catIndex });
            });
          });
          
          if (allTodos.length === 0) return;
          
          const randomTodo = allTodos[Math.floor(Math.random() * allTodos.length)];
          const availableCategories = categories.filter((_, index) => index !== randomTodo.categoryIndex);
          
          if (availableCategories.length === 0) return;
          
          const targetCategory = availableCategories[Math.floor(Math.random() * availableCategories.length)];
          const targetIndex = categories.indexOf(targetCategory);
          
          moveTodoToCategory(randomTodo.todo.id, categories[randomTodo.categoryIndex].id, targetIndex);
        };

        window.moveTodoToCategory = function(todoId, fromCategoryId, direction) {
          const categories = juris.getState('categories', []);
          const fromIndex = categories.findIndex(cat => cat.id === fromCategoryId);
          
          let toIndex;
          if (direction === 'prev') {
            toIndex = fromIndex > 0 ? fromIndex - 1 : categories.length - 1;
          } else if (direction === 'next') {
            toIndex = fromIndex < categories.length - 1 ? fromIndex + 1 : 0;
          } else {
            toIndex = direction; // Direct index
          }
          
          if (fromIndex === toIndex) return;
          
          const todoToMove = categories[fromIndex].todos.find(t => t.id === todoId);
          if (!todoToMove) return;
          
          const updatedCategories = categories.map((cat, index) => {
            if (index === fromIndex) {
              return {
                ...cat,
                todos: cat.todos.filter(t => t.id !== todoId)
              };
            } else if (index === toIndex) {
              return {
                ...cat,
                todos: [...cat.todos, todoToMove]
              };
            }
            return cat;
          });
          
          juris.setState('categories', updatedCategories);
          logDebug(`Moved todo ${todoId} from ${categories[fromIndex].name} to ${categories[toIndex].name}`);
        };

        window.toggleRandomTodo = function() {
          const categories = juris.getState('categories', []);
          
          // Find all todos
          const allTodos = [];
          categories.forEach((cat, catIndex) => {
            cat.todos.forEach(todo => {
              allTodos.push({ todo, categoryIndex: catIndex, categoryId: cat.id });
            });
          });
          
          if (allTodos.length === 0) return;
          
          const randomTodo = allTodos[Math.floor(Math.random() * allTodos.length)];
          
          const updatedCategories = categories.map(cat => {
            if (cat.id === randomTodo.categoryId) {
              return {
                ...cat,
                todos: cat.todos.map(t => 
                  t.id === randomTodo.todo.id ? {...t, done: !t.done} : t
                )
              };
            }
            return cat;
          });
          
          juris.setState('categories', updatedCategories);
          logDebug(`Toggled todo ${randomTodo.todo.id} in category ${categories[randomTodo.categoryIndex].name}`);
        };

        window.shuffleCategories = function() {
          const categories = juris.getState('categories', []);
          const shuffled = [...categories].sort(() => Math.random() - 0.5);
          juris.setState('categories', shuffled);
          logDebug('Shuffled categories order');
        };

        window.addCategory = function() {
          const categories = juris.getState('categories', []);
          const nextCategoryId = juris.getState('nextCategoryId', 1);
          
          const categoryNames = ['Urgent', 'Ideas', 'Later', 'Shopping', 'Health', 'Projects', 'Fun'];
          const usedNames = categories.map(cat => cat.name);
          const availableNames = categoryNames.filter(name => !usedNames.includes(name));
          
          if (availableNames.length === 0) {
            logDebug('No more category names available');
            return;
          }
          
          const randomName = availableNames[Math.floor(Math.random() * availableNames.length)];
          
          const newCategory = {
            id: nextCategoryId,
            name: randomName,
            todos: []
          };
          
          juris.setState('categories', [...categories, newCategory]);
          juris.setState('nextCategoryId', nextCategoryId + 1);
          logDebug(`Added new category: ${randomName}`);
        };

        window.clearDebug = function() {
          juris.setState('debugLog', []);
          const debugInfo = document.getElementById('debugInfo');
          if (debugInfo) {
            debugInfo.textContent = 'Debug cleared...';
          }
        };

        // Set up layout and render
        juris.layout = { App: {} };
        
        // Render the app
        setTimeout(() => {
          juris.render('#app');
          logDebug('Nested SmartList test initialized');
        }, 100);
    </script>
</body>
</html>