<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juris.js Feature Test Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f9f9f9;
        }
        .test-container {
            background: white;
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 15px;
        }
        .test-container h3 {
            margin-top: 0;
            color: #333;
        }
        .test-result {
            padding: 8px;
            margin: 8px 0;
            border-radius: 4px;
        }
        .test-result.pass {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-result.fail {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .test-result.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 4px;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover {
            background: #0056b3;
        }
        .code-output {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        input, select, textarea {
            padding: 6px;
            margin: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .demo-area {
            border: 2px dashed #ccc;
            padding: 15px;
            margin: 10px 0;
            min-height: 100px;
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 15px;
        }
    </style>
</head>
<body>
    <h1>Juris.js Feature Test Page</h1>
    <div id="framework-status" class="test-result info">Loading Juris.js from https://jurisjs.com/juris.js...</div>
    
    <div class="feature-grid">
        <!-- Core State Management -->
        <div class="test-container">
            <h3>1. Core State Management</h3>
            <button onclick="testStateManagement()">Test State Operations</button>
            <div id="state-test" class="code-output">Ready to test...</div>
        </div>

        <!-- Reactive Components -->
        <div class="test-container">
            <h3>2. Reactive Components</h3>
            <button onclick="testReactiveComponents()">Test Reactivity</button>
            <div id="reactive-demo" class="demo-area">Component will render here...</div>
            <div id="reactive-test" class="code-output">Ready to test...</div>
        </div>

        <!-- Component Lifecycle -->
        <div class="test-container">
            <h3>3. Component Lifecycle</h3>
            <button onclick="testComponentLifecycle()">Test Lifecycle Hooks</button>
            <div id="lifecycle-demo" class="demo-area">Component will render here...</div>
            <div id="lifecycle-test" class="code-output">Ready to test...</div>
        </div>

        <!-- Event Handling -->
        <div class="test-container">
            <h3>4. Event Handling</h3>
            <button onclick="testEventHandling()">Test Events</button>
            <div id="event-demo" class="demo-area">Interactive elements will render here...</div>
            <div id="event-test" class="code-output">Ready to test...</div>
        </div>

        <!-- Router System -->
        <div class="test-container">
            <h3>5. Router System</h3>
            <button onclick="testRouter()">Test Router</button>
            <div id="router-demo" class="demo-area">Router will render here...</div>
            <div id="router-test" class="code-output">Ready to test...</div>
        </div>

        <!-- Enhancement System -->
        <div class="test-container">
            <h3>6. DOM Enhancement</h3>
            <button onclick="testEnhancement()">Test Enhancement</button>
            <div id="enhancement-demo" class="demo-area">
                <div class="enhance-me" data-value="initial">Element to enhance</div>
            </div>
            <div id="enhancement-test" class="code-output">Ready to test...</div>
        </div>

        <!-- State Subscriptions -->
        <div class="test-container">
            <h3>7. State Subscriptions</h3>
            <button onclick="testSubscriptions()">Test Subscriptions</button>
            <div id="subscription-test" class="code-output">Ready to test...</div>
        </div>

        <!-- Component API -->
        <div class="test-container">
            <h3>8. Component API</h3>
            <button onclick="testComponentAPI()">Test Component Management</button>
            <div id="api-demo" class="demo-area">Components will render here...</div>
            <div id="api-test" class="code-output">Ready to test...</div>
        </div>

        <!-- Services Integration -->
        <div class="test-container">
            <h3>9. Services Integration</h3>
            <button onclick="testServices()">Test Services</button>
            <div id="services-test" class="code-output">Ready to test...</div>
        </div>

        <!-- HTML Rendering -->
        <div class="test-container">
            <h3>10. HTML Rendering (style, html, unsafeHtml)</h3>
            <button onclick="testHTMLRendering()">Test HTML Features</button>
            <div id="html-demo" class="demo-area">HTML rendering tests will appear here...</div>
            <div id="html-test" class="code-output">Ready to test...</div>
        </div>

        <!-- Error Handling -->
        <div class="test-container">
            <h3>11. Error Handling</h3>
            <button onclick="testErrorHandling()">Test Error Handling</button>
            <div id="error-demo" class="demo-area">Error test area...</div>
            <div id="error-test" class="code-output">Ready to test...</div>
        </div>
    </div>

    <!-- Global Controls -->
    <div class="test-container">
        <h3>Global Test Controls</h3>
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="clearAllOutputs()">Clear All Outputs</button>
        <button onclick="inspectFramework()">Inspect Framework State</button>
        <div id="global-output" class="code-output">Global test output...</div>
    </div>

    <script src="../src/juris.js"></script>
    <script>
        let app = null;
        let testResults = {};

        function logger(message, outputId) {
            const element = document.getElementById(outputId);
            if (element) {
                element.textContent += `[${new Date().toLocaleTimeString()}] ${message}\n`;
                element.scrollTop = element.scrollHeight;
            }
            console.log(message);
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('framework-status');
            statusEl.className = `test-result ${type}`;
            statusEl.textContent = message;
        }

        function markTestResult(testName, passed, message) {
            testResults[testName] = { passed, message };
            logger(`${passed ? 'PASS' : 'FAIL'}: ${message}`, 'global-output');
        }

        window.addEventListener('load', function() {
            if (typeof Juris !== 'undefined') {
                updateStatus('Juris.js loaded successfully!', 'pass');
                logger('Juris framework available', 'global-output');
            } else {
                updateStatus('Failed to load Juris.js', 'fail');
                logger('ERROR: Juris framework not available', 'global-output');
            }
        });

        // Test 1: Core State Management
        function testStateManagement() {
            logger('=== Testing Core State Management ===', 'state-test');
            
            try {
                app = new Juris({
                    states: {
                        counter: 0,
                        user: { name: 'John', age: 30 },
                        config: { theme: 'light' }
                    }
                });

                // Test basic setState/getState
                logger('Initial state:', 'state-test');
                logger(`counter: ${app.getState('counter')}`, 'state-test');
                logger(`user.name: ${app.getState('user.name')}`, 'state-test');

                // Test state changes
                app.setState('counter', 5);
                app.setState('user.age', 31);
                app.setState('config.theme', 'dark');

                logger('After changes:', 'state-test');
                logger(`counter: ${app.getState('counter')}`, 'state-test');
                logger(`user.age: ${app.getState('user.age')}`, 'state-test');
                logger(`config.theme: ${app.getState('config.theme')}`, 'state-test');

                // Test useState functionality
                const [getValue, setValue] = app.useState('test.value', 'initial');
                logger(`useState initial: ${getValue()}`, 'state-test');
                setValue('updated');
                logger(`useState after update: ${getValue()}`, 'state-test');

                markTestResult('State Management', true, 'State operations work correctly');
                
            } catch (error) {
                logger(`ERROR: ${error.message}`, 'state-test');
                markTestResult('State Management', false, error.message);
            }
        }

        // Test 2: Reactive Components
        function testReactiveComponents() {
            logger('=== Testing Reactive Components ===', 'reactive-test');
            
            try {
                if (!app) {
                    app = new Juris({ states: { count: 0, text: 'Hello' } });
                }

                app.registerComponent('ReactiveCounter', (props, context) => {
                    return {
                        render: () => ({
                            div: {
                                children: [
                                    {
                                        h4: {
                                            text: () => `Count: ${context.getState('count', 0)}`
                                        }
                                    },
                                    {
                                        p: {
                                            text: () => `Text: ${context.getState('text', 'N/A')}`
                                        }
                                    },
                                    {
                                        button: {
                                            text: 'Increment',
                                            onClick: () => {
                                                const current = context.getState('count', 0);
                                                context.setState('count', current + 1);
                                            }
                                        }
                                    },
                                    {
                                        button: {
                                            text: 'Change Text',
                                            onClick: () => {
                                                const texts = ['Hello', 'World', 'Juris', 'Reactive'];
                                                const current = context.getState('text', 'Hello');
                                                const currentIndex = texts.indexOf(current);
                                                const nextIndex = (currentIndex + 1) % texts.length;
                                                context.setState('text', texts[nextIndex]);
                                            }
                                        }
                                    }
                                ]
                            }
                        })
                    };
                });

                app.layout = { ReactiveCounter: {} };
                app.render('#reactive-demo');

                logger('Reactive component rendered', 'reactive-test');
                logger('Try clicking the buttons to test reactivity', 'reactive-test');
                
                markTestResult('Reactive Components', true, 'Component rendered and interactive');
                
            } catch (error) {
                logger(`ERROR: ${error.message}`, 'reactive-test');
                markTestResult('Reactive Components', false, error.message);
            }
        }

        // Test 3: Component Lifecycle
        function testComponentLifecycle() {
            logger('=== Testing Component Lifecycle ===', 'lifecycle-test');
            
            try {
                if (!app) {
                    app = new Juris({ states: { lifecycleTest: true } });
                }

                app.registerComponent('LifecycleTest', (props, context) => {
                    return {
                        render: () => ({
                            div: {
                                className: 'lifecycle-component',
                                children: [
                                    { h4: { text: 'Lifecycle Test Component' } },
                                    { p: { text: 'Check console for lifecycle events' } }
                                ]
                            }
                        }),

                        onMount: (element, props, context) => {
                            logger('onMount: Component mounted', 'lifecycle-test');
                            return () => logger('onMount cleanup called', 'lifecycle-test');
                        },

                        onUpdate: (element, newProps, oldProps, context) => {
                            logger('onUpdate: Component updated', 'lifecycle-test');
                        },

                        onUnmount: (element, props, context) => {
                            logger('onUnmount: Component unmounting', 'lifecycle-test');
                        },

                        onError: (error, element, props, context) => {
                            logger(`onError: ${error.message}`, 'lifecycle-test');
                        }
                    };
                });

                app.layout = { LifecycleTest: {} };
                app.render('#lifecycle-demo');

                logger('Lifecycle component rendered', 'lifecycle-test');
                
                // Test unmount
                setTimeout(() => {
                    app.layout = { div: { text: 'Component removed' } };
                    app.render('#lifecycle-demo');
                    logger('Component removed to test unmount', 'lifecycle-test');
                }, 2000);

                markTestResult('Component Lifecycle', true, 'Lifecycle hooks working');
                
            } catch (error) {
                logger(`ERROR: ${error.message}`, 'lifecycle-test');
                markTestResult('Component Lifecycle', false, error.message);
            }
        }

        // Test 4: Event Handling
        function testEventHandling() {
            logger('=== Testing Event Handling ===', 'event-test');
            
            try {
                if (!app) {
                    app = new Juris({ states: { clickCount: 0, inputValue: '' } });
                }

                app.registerComponent('EventTest', (props, context) => {
                    return {
                        render: () => ({
                            div: {
                                children: [
                                    {
                                        button: {
                                            text: () => `Clicked ${context.getState('clickCount', 0)} times`,
                                            onClick: (e) => {
                                                const count = context.getState('clickCount', 0);
                                                context.setState('clickCount', count + 1);
                                                logger(`Button clicked: ${count + 1}`, 'event-test');
                                            }
                                        }
                                    },
                                    {
                                        input: {
                                            type: 'text',
                                            placeholder: 'Type something...',
                                            value: () => context.getState('inputValue', ''),
                                            onInput: (e) => {
                                                context.setState('inputValue', e.target.value);
                                                logger(`Input changed: ${e.target.value}`, 'event-test');
                                            }
                                        }
                                    },
                                    {
                                        p: {
                                            text: () => `Input value: "${context.getState('inputValue', '')}"`
                                        }
                                    }
                                ]
                            }
                        })
                    };
                });

                app.layout = { EventTest: {} };
                app.render('#event-demo');

                logger('Event handling component rendered', 'event-test');
                markTestResult('Event Handling', true, 'Events working correctly');
                
            } catch (error) {
                logger(`ERROR: ${error.message}`, 'event-test');
                markTestResult('Event Handling', false, error.message);
            }
        }

        // Test 5: Router System
        function testRouter() {
            logger('=== Testing Router System ===', 'router-test');
            
            try {
                // Router expects #app container - create one in our demo area
                const routerContainer = document.getElementById('router-demo');
                routerContainer.innerHTML = '<div id="app" style="border: 1px solid #ccc; padding: 10px;"></div>';
                
                const routerApp = new Juris({
                    router: {
                        mode: 'hash',
                        routes: {
                            '/': 'HomePage',
                            '/about': 'AboutPage',
                            '/user/:id': 'UserPage'
                        }
                    },
                    components: {
                        HomePage: (props, context) => ({
                            div: { 
                                children: [
                                    { h4: { text: 'Home Page' } },
                                    { p: { text: 'This is the home page content.' } }
                                ],
                                style: { padding: '10px', backgroundColor: '#e8f5e8', borderRadius: '4px' }
                            }
                        }),
                        AboutPage: (props, context) => ({
                            div: { 
                                children: [
                                    { h4: { text: 'About Page' } },
                                    { p: { text: 'This is the about page content.' } }
                                ],
                                style: { padding: '10px', backgroundColor: '#e8f0ff', borderRadius: '4px' }
                            }
                        }),
                        UserPage: (props, context) => ({
                            div: {
                                children: [
                                    { h4: { text: 'User Profile Page' } },
                                    { p: { text: () => `Viewing user with ID: ${context.getState('router.params.id', 'unknown')}` } },
                                    { p: { text: () => `Current route: ${context.getState('router.currentRoute', '/')}` } }
                                ],
                                style: { padding: '10px', backgroundColor: '#fff8e1', borderRadius: '4px' }
                            }
                        }),
                        Router: (props, context) => {
                            return {
                                render: () => {
                                    const currentRoute = context.getState('router.currentRoute', '/');
                                    const isLoading = context.getState('router.isLoading', false);
                                    const error = context.getState('router.error', null);
                                    const params = context.getState('router.params', {});
                                    const notFound = context.getState('router.notFound', false);
                                    
                                    logger(`Router rendering: route="${currentRoute}", loading=${isLoading}, error="${error}", notFound=${notFound}`, 'router-test');
                                    
                                    // Navigation component
                                    const navigation = {
                                        div: {
                                            style: { 
                                                marginBottom: '15px', 
                                                padding: '10px', 
                                                backgroundColor: '#f8f9fa',
                                                borderRadius: '4px',
                                                border: '1px solid #dee2e6'
                                            },
                                            children: [
                                                { h5: { text: 'Router Navigation', style: { margin: '0 0 10px 0' } } },
                                                {
                                                    div: {
                                                        children: [
                                                            {
                                                                a: {
                                                                    text: 'Home',
                                                                    href: '#/',
                                                                    style: { 
                                                                        marginRight: '10px', 
                                                                        padding: '5px 10px',
                                                                        backgroundColor: currentRoute === '/' ? '#007bff' : '#6c757d',
                                                                        color: 'white',
                                                                        textDecoration: 'none',
                                                                        borderRadius: '3px',
                                                                        fontSize: '12px'
                                                                    }
                                                                }
                                                            },
                                                            {
                                                                a: {
                                                                    text: 'About',
                                                                    href: '#/about',
                                                                    style: { 
                                                                        marginRight: '10px', 
                                                                        padding: '5px 10px',
                                                                        backgroundColor: currentRoute === '/about' ? '#007bff' : '#6c757d',
                                                                        color: 'white',
                                                                        textDecoration: 'none',
                                                                        borderRadius: '3px',
                                                                        fontSize: '12px'
                                                                    }
                                                                }
                                                            },
                                                            {
                                                                a: {
                                                                    text: 'User 123',
                                                                    href: '#/user/123',
                                                                    style: { 
                                                                        marginRight: '10px', 
                                                                        padding: '5px 10px',
                                                                        backgroundColor: currentRoute.startsWith('/user') ? '#007bff' : '#6c757d',
                                                                        color: 'white',
                                                                        textDecoration: 'none',
                                                                        borderRadius: '3px',
                                                                        fontSize: '12px'
                                                                    }
                                                                }
                                                            },
                                                            {
                                                                a: {
                                                                    text: 'Invalid Route',
                                                                    href: '#/nonexistent',
                                                                    style: { 
                                                                        padding: '5px 10px',
                                                                        backgroundColor: '#dc3545',
                                                                        color: 'white',
                                                                        textDecoration: 'none',
                                                                        borderRadius: '3px',
                                                                        fontSize: '12px'
                                                                    }
                                                                }
                                                            }
                                                        ]
                                                    }
                                                }
                                            ]
                                        }
                                    };
                                    
                                    // Loading state
                                    if (isLoading) {
                                        return {
                                            div: {
                                                children: [
                                                    navigation,
                                                    {
                                                        div: {
                                                            text: 'Loading route...',
                                                            style: { 
                                                                padding: '20px', 
                                                                textAlign: 'center',
                                                                color: '#666',
                                                                fontStyle: 'italic'
                                                            }
                                                        }
                                                    }
                                                ]
                                            }
                                        };
                                    }
                                    
                                    // Error state
                                    if (error) {
                                        return {
                                            div: {
                                                children: [
                                                    navigation,
                                                    {
                                                        div: {
                                                            text: `Router Error: ${error}`,
                                                            style: { 
                                                                padding: '10px', 
                                                                color: 'red', 
                                                                backgroundColor: '#ffe6e6',
                                                                border: '1px solid #ffcccc',
                                                                borderRadius: '4px'
                                                            }
                                                        }
                                                    }
                                                ]
                                            }
                                        };
                                    }
                                    
                                    // 404 state
                                    if (notFound) {
                                        return {
                                            div: {
                                                children: [
                                                    navigation,
                                                    {
                                                        div: {
                                                            children: [
                                                                { h4: { text: '404 - Page Not Found' } },
                                                                { p: { text: `The route "${currentRoute}" does not exist.` } },
                                                                { p: { text: 'Use the navigation above to go to a valid page.' } }
                                                            ],
                                                            style: { 
                                                                padding: '20px', 
                                                                textAlign: 'center',
                                                                backgroundColor: '#fff3cd',
                                                                border: '1px solid #ffeaa7',
                                                                borderRadius: '4px'
                                                            }
                                                        }
                                                    }
                                                ]
                                            }
                                        };
                                    }
                                    
                                    // Find and render the matched component
                                    const matchResult = context.juris.matchRoute(currentRoute);
                                    if (!matchResult) {
                                        return {
                                            div: {
                                                children: [
                                                    navigation,
                                                    {
                                                        div: {
                                                            text: `No route matched: ${currentRoute}`,
                                                            style: { padding: '10px', color: 'orange' }
                                                        }
                                                    }
                                                ]
                                            }
                                        };
                                    }
                                    
                                    const { config } = matchResult;
                                    const componentName = typeof config === 'string' ? config : config.component;
                                    
                                    if (!componentName || !context.juris.components.has(componentName)) {
                                        return {
                                            div: {
                                                children: [
                                                    navigation,
                                                    {
                                                        div: {
                                                            text: `Component "${componentName}" not found`,
                                                            style: { padding: '10px', color: 'red' }
                                                        }
                                                    }
                                                ]
                                            }
                                        };
                                    }
                                    
                                    // Render the matched component
                                    return {
                                        div: {
                                            children: [
                                                navigation,
                                                {
                                                    div: {
                                                        style: { marginTop: '10px' },
                                                        children: [
                                                            {
                                                                [componentName]: { 
                                                                    routeParams: params,
                                                                    routePath: currentRoute
                                                                }
                                                            }
                                                        ]
                                                    }
                                                }
                                            ]
                                        }
                                    };
                                }
                            };
                        }
                    },
                    layout: { Router: {} }
                });

                // Router will automatically render to the #app container we created
                logger('Router app created, it will automatically render to #app container', 'router-test');
                logger('Initial route should be loaded automatically', 'router-test');
                
                // Test programmatic navigation
                setTimeout(() => {
                    logger('Testing programmatic navigation to /about...', 'router-test');
                    routerApp.navigate('/about');
                }, 1500);

                setTimeout(() => {
                    logger('Testing programmatic navigation to /user/456...', 'router-test');
                    routerApp.navigate('/user/456');
                }, 3000);
                
                setTimeout(() => {
                    logger('Testing navigation to invalid route...', 'router-test');
                    routerApp.navigate('/nonexistent');
                }, 4500);

                setTimeout(() => {
                    logger('Testing navigation back to home...', 'router-test');
                    routerApp.navigate('/');
                }, 6000);

                logger('✓ Router system initialized with hash mode routing', 'router-test');
                logger('✓ Routes configured: /, /about, /user/:id', 'router-test');
                logger('✓ Navigation links available for manual testing', 'router-test');
                logger('✓ Programmatic navigation tests will run automatically', 'router-test');
                
                markTestResult('Router System', true, 'Router initialized and working with #app container');
                
            } catch (error) {
                logger(`ERROR: ${error.message}`, 'router-test');
                logger(`Stack: ${error.stack}`, 'router-test');
                markTestResult('Router System', false, error.message);
            }
        }

        // Test 6: Enhancement System
        function testEnhancement() {
            logger('=== Testing DOM Enhancement ===', 'enhancement-test');
            
            try {
                if (!app) {
                    app = new Juris({});
                }

                app.enhance('.enhance-me', (props, context) => ({
                    text: () => `Enhanced: ${props.dataset.value}`,
                    style: {
                        backgroundColor: 'lightblue',
                        padding: '10px',
                        border: '1px solid blue'
                    },
                    onClick: () => {
                        const current = props.element.dataset.value;
                        props.element.dataset.value = current === 'initial' ? 'clicked' : 'initial';
                        logger(`Element clicked, value: ${props.element.dataset.value}`, 'enhancement-test');
                    }
                }));

                logger('DOM enhancement applied to .enhance-me elements', 'enhancement-test');
                logger('Click the enhanced element to test interactivity', 'enhancement-test');
                
                markTestResult('DOM Enhancement', true, 'Enhancement system working');
                
            } catch (error) {
                logger(`ERROR: ${error.message}`, 'enhancement-test');
                markTestResult('DOM Enhancement', false, error.message);
            }
        }

        // Test 7: State Subscriptions
        function testSubscriptions() {
            logger('=== Testing State Subscriptions ===', 'subscription-test');
            
            try {
                if (!app) {
                    app = new Juris({ 
                        states: { 
                            test: 'initial',
                            testObject: {
                                nested: 'initial nested value'
                            }
                        } 
                    });
                }

                let subscriptionCount = 0;
                let objectSubscriptionCount = 0;
                
                // Test 1: Subscribe to string value
                const unsubscribe1 = app.subscribe('test', (newValue, oldValue, path) => {
                    subscriptionCount++;
                    logger(`String subscription fired #${subscriptionCount}: ${path} = "${newValue}" (was: "${oldValue}")`, 'subscription-test');
                });

                // Test 2: Subscribe to object property
                const unsubscribe2 = app.subscribe('testObject.nested', (newValue, oldValue, path) => {
                    objectSubscriptionCount++;
                    logger(`Object property subscription fired #${objectSubscriptionCount}: ${path} = "${newValue}" (was: "${oldValue}")`, 'subscription-test');
                });

                logger('Subscribed to "test" (string) and "testObject.nested" (object property)', 'subscription-test');
                
                // Test string value changes
                setTimeout(() => {
                    logger('\nTesting string value changes...', 'subscription-test');
                    app.setState('test', 'first change');
                }, 100);
                
                setTimeout(() => {
                    app.setState('test', 'second change');
                }, 200);
                
                // Test object property changes
                setTimeout(() => {
                    logger('\nTesting object property changes...', 'subscription-test');
                    app.setState('testObject.nested', 'first nested change');
                }, 300);
                
                setTimeout(() => {
                    app.setState('testObject.nested', 'second nested change');
                }, 400);
                
                // Test object replacement
                setTimeout(() => {
                    logger('\nTesting object replacement...', 'subscription-test');
                    app.setState('testObject', {
                        nested: 'replaced nested value',
                        newProperty: 'new value'
                    });
                }, 500);
                
                // Test non-matching path (should not trigger subscriptions)
                setTimeout(() => {
                    logger('\nTesting non-matching path changes...', 'subscription-test');
                    app.setState('different.path', 'should not trigger');
                }, 600);
                
                // Test results and cleanup
                setTimeout(() => {
                    logger(`\nFinal subscription counts:`, 'subscription-test');
                    logger(`- String subscriptions: ${subscriptionCount}`, 'subscription-test');
                    logger(`- Object property subscriptions: ${objectSubscriptionCount}`, 'subscription-test');
                    
                    // Expected: 2 string subscriptions, 3 object property subscriptions
                    // (2 direct changes + 1 from object replacement)
                    const stringExpected = subscriptionCount >= 2;
                    const objectExpected = objectSubscriptionCount >= 2;
                    
                    if (stringExpected && objectExpected) {
                        logger('✓ String value subscriptions working correctly', 'subscription-test');
                        logger('✓ Object property subscriptions working correctly', 'subscription-test');
                        markTestResult('State Subscriptions', true, 'All subscription types working');
                    } else {
                        logger(`✗ Unexpected subscription counts - String: ${subscriptionCount}, Object: ${objectSubscriptionCount}`, 'subscription-test');
                        markTestResult('State Subscriptions', false, 'Subscription counts unexpected');
                    }
                    
                    // Test unsubscribe
                    logger('\nTesting unsubscribe functionality...', 'subscription-test');
                    unsubscribe1();
                    unsubscribe2();
                    
                    // These changes should not trigger any more subscriptions
                    app.setState('test', 'after unsubscribe');
                    app.setState('testObject.nested', 'after unsubscribe');
                    
                    setTimeout(() => {
                        logger('✓ Unsubscribed - no more notifications should appear above', 'subscription-test');
                        logger('✓ Subscription system test completed', 'subscription-test');
                    }, 100);
                    
                }, 700);
                
            } catch (error) {
                logger(`ERROR: ${error.message}`, 'subscription-test');
                logger(`Stack: ${error.stack}`, 'subscription-test');
                markTestResult('State Subscriptions', false, error.message);
            }
        }

        // Test 8: Component API
        function testComponentAPI() {
            logger('=== Testing Component API ===', 'api-test');
            
            try {
                if (!app) {
                    app = new Juris({});
                }

                app.registerComponent('APITestComponent', (props, context) => {
                    return {
                        render: () => ({
                            div: {
                                className: 'api-test-component',
                                children: [
                                    { h4: { text: 'API Test Component' } },
                                    { p: { text: () => `Prop value: ${props.value || 'none'}` } }
                                ]
                            }
                        }),
                        
                        customMethod: () => {
                            logger('Custom method called!', 'api-test');
                            return 'method result';
                        }
                    };
                });

                app.layout = { APITestComponent: { value: 'initial' } };
                app.render('#api-demo');

                // Test component management
                const components = app.getComponents();
                logger(`Found ${components.length} components`, 'api-test');

                const component = app.getComponent('APITestComponent');
                if (component && component.customMethod) {
                    const result = component.customMethod();
                    logger(`Custom method result: ${result}`, 'api-test');
                }

                // Test component update
                app.updateComponent('APITestComponent', { value: 'updated' });
                logger('Component props updated', 'api-test');

                markTestResult('Component API', true, 'Component management API working');
                
            } catch (error) {
                logger(`ERROR: ${error.message}`, 'api-test');
                markTestResult('Component API', false, error.message);
            }
        }

        // Test 9: Services Integration
        function testServices() {
            logger('=== Testing Services Integration ===', 'services-test');
            
            try {
                const servicesApp = new Juris({
                    services: {
                        api: {
                            get: (url) => Promise.resolve({ data: `Mock data for ${url}` }),
                            post: (url, data) => Promise.resolve({ success: true, data })
                        },
                        utils: {
                            formatDate: (date) => date.toLocaleDateString(),
                            generateId: () => Math.random().toString(36).substr(2, 9)
                        }
                    }
                });

                servicesApp.registerComponent('ServicesTest', (props, context) => {
                    return {
                        render: () => ({
                            div: {
                                children: [
                                    {
                                        button: {
                                            text: 'Test API Service',
                                            onClick: async () => {
                                                const result = await context.services.api.get('/test');
                                                logger(`API result: ${JSON.stringify(result)}`, 'services-test');
                                            }
                                        }
                                    },
                                    {
                                        button: {
                                            text: 'Test Utils Service',
                                            onClick: () => {
                                                const id = context.services.utils.generateId();
                                                const date = context.services.utils.formatDate(new Date());
                                                logger(`Generated ID: ${id}`, 'services-test');
                                                logger(`Formatted date: ${date}`, 'services-test');
                                            }
                                        }
                                    }
                                ]
                            }
                        })
                    };
                });

                logger('Services configured: api, utils', 'services-test');
                markTestResult('Services Integration', true, 'Services system working');
                
            } catch (error) {
                logger(`ERROR: ${error.message}`, 'services-test');
                markTestResult('Services Integration', false, error.message);
            }
        }

        // Test 10: HTML Rendering
        function testHTMLRendering() {
            logger('=== Testing HTML Rendering Features ===', 'html-test');
            
            try {
                if (!app) {
                    app = new Juris({ 
                        states: { 
                            dynamicColor: 'blue',
                            htmlContent: '<p>Dynamic <strong>HTML</strong> content</p>',
                            unsafeContent: '<script>alert("XSS Test")<\/script><p>Unsafe content with <em>formatting</em></p>',
                            styleToggle: false
                        } 
                    });
                }

                app.registerComponent('HTMLTestComponent', (props, context) => {
                    return {
                        render: () => ({
                            div: {
                                className: 'html-test-container',
                                children: [
                                    {
                                        h4: { 
                                            text: 'HTML Rendering Tests',
                                            style: {
                                                color: () => context.getState('dynamicColor', 'black'),
                                                fontSize: '18px',
                                                marginBottom: '10px'
                                            }
                                        }
                                    },
                                    
                                    // Test 1: Static styles
                                    {
                                        div: {
                                            text: 'Static Styled Element',
                                            style: {
                                                backgroundColor: 'lightgreen',
                                                padding: '10px',
                                                margin: '5px 0',
                                                border: '1px solid green',
                                                borderRadius: '4px'
                                            }
                                        }
                                    },
                                    
                                    // Test 2: Dynamic styles
                                    {
                                        div: {
                                            text: 'Dynamic Styled Element (click to change color)',
                                            style: {
                                                backgroundColor: () => context.getState('styleToggle', false) ? 'lightcoral' : 'lightyellow',
                                                padding: '10px',
                                                margin: '5px 0',
                                                border: () => `2px solid ${context.getState('dynamicColor', 'blue')}`,
                                                borderRadius: '4px',
                                                cursor: 'pointer',
                                                transition: 'all 0.3s ease'
                                            },
                                            onClick: () => {
                                                const current = context.getState('styleToggle', false);
                                                context.setState('styleToggle', !current);
                                                logger('Style toggle clicked', 'html-test');
                                            }
                                        }
                                    },
                                    
                                    // Test 3: Static HTML content
                                    {
                                        div: {
                                            className: 'static-html-test',
                                            html: '<p>Static HTML: <strong>Bold text</strong>, <em>italic text</em>, and <a href="#" onclick="return false;">a link</a></p>',
                                            style: {
                                                backgroundColor: '#f0f0f0',
                                                padding: '10px',
                                                margin: '5px 0',
                                                border: '1px solid #ccc'
                                            }
                                        }
                                    },
                                    
                                    // Test 4: Dynamic HTML content
                                    {
                                        div: {
                                            className: 'dynamic-html-test',
                                            html: () => context.getState('htmlContent', '<p>Default content</p>'),
                                            style: {
                                                backgroundColor: '#e6f3ff',
                                                padding: '10px',
                                                margin: '5px 0',
                                                border: '1px solid #0066cc'
                                            }
                                        }
                                    },
                                    
                                    // Test 5: Unsafe HTML content (should be sanitized)
                                    {
                                        div: {
                                            className: 'unsafe-html-test',
                                            dangerousHtml: () => context.getState('unsafeContent', '<p>Default unsafe content</p>'),
                                            style: {
                                                backgroundColor: '#ffe6e6',
                                                padding: '10px',
                                                margin: '5px 0',
                                                border: '1px solid #cc0000'
                                            }
                                        }
                                    },
                                    
                                    // Test 6: Complex nested HTML
                                    {
                                        div: {
                                            html: '<div style="background: linear-gradient(45deg, #ff6b6b, #4ecdc4); padding: 15px; border-radius: 8px; color: white;">' +
                                                  '<h5 style="margin: 0 0 10px 0;">Complex HTML Structure</h5>' +
                                                  '<ul style="margin: 0; padding-left: 20px;">' +
                                                  '<li>List item with <code style="background: rgba(255,255,255,0.2); padding: 2px 4px; border-radius: 2px;">code</code></li>' +
                                                  '<li>Another item with <span style="text-decoration: underline;">underlined text</span></li>' +
                                                  '<li>Item with <small style="font-size: 0.8em;">small text</small></li>' +
                                                  '</ul>' +
                                                  '</div>'
                                        }
                                    },
                                    
                                    // Control buttons
                                    {
                                        div: {
                                            style: { marginTop: '15px' },
                                            children: [
                                                {
                                                    button: {
                                                        text: 'Change Color',
                                                        onClick: () => {
                                                            const colors = ['blue', 'red', 'green', 'purple', 'orange'];
                                                            const current = context.getState('dynamicColor', 'blue');
                                                            const currentIndex = colors.indexOf(current);
                                                            const nextIndex = (currentIndex + 1) % colors.length;
                                                            context.setState('dynamicColor', colors[nextIndex]);
                                                            logger(`Color changed to: ${colors[nextIndex]}`, 'html-test');
                                                        }
                                                    }
                                                },
                                                {
                                                    button: {
                                                        text: 'Update HTML Content',
                                                        onClick: () => {
                                                            const contents = [
                                                                '<p>Updated <strong>HTML</strong> content</p>',
                                                                '<p>Different <em>italic</em> content with <span style="color: red;">red text</span></p>',
                                                                '<p>Content with <u>underlined</u> and <mark>highlighted</mark> text</p>',
                                                                '<p>List content: <ul><li>Item 1</li><li>Item 2</li></ul></p>'
                                                            ];
                                                            const current = context.getState('htmlContent');
                                                            const currentIndex = contents.indexOf(current);
                                                            const nextIndex = (currentIndex + 1) % contents.length;
                                                            context.setState('htmlContent', contents[nextIndex]);
                                                            logger('HTML content updated', 'html-test');
                                                        }
                                                    }
                                                },
                                                {
                                                    button: {
                                                        text: 'Update Unsafe Content',
                                                        onClick: () => {
                                                            const unsafeContents = [
                                                                '<script>console.log("Script blocked")<\/script><p>Content with <strong>script</strong> tag</p>',
                                                                '<p>Content with iframe (should be blocked)</p>',
                                                                '<p>Content with image error handler (should be sanitized)</p>',
                                                                '<p>Content with click handler (should be sanitized)</p>',
                                                                '<p>Safe content with <em>formatting</em> only</p>'
                                                            ];
                                                            const current = context.getState('unsafeContent');
                                                            const currentIndex = unsafeContents.indexOf(current);
                                                            const nextIndex = (currentIndex + 1) % unsafeContents.length;
                                                            context.setState('unsafeContent', unsafeContents[nextIndex]);
                                                            logger('Unsafe content updated (should be sanitized)', 'html-test');
                                                        }
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                ]
                            }
                        })
                    };
                });

                app.layout = { HTMLTestComponent: {} };
                app.render('#html-demo');

                logger('HTML rendering component created with:', 'html-test');
                logger('✓ Static styles (background, padding, border, etc.)', 'html-test');
                logger('✓ Dynamic styles (reactive to state changes)', 'html-test');
                logger('✓ Static HTML content (html attribute)', 'html-test');
                logger('✓ Dynamic HTML content (reactive html attribute)', 'html-test');
                logger('✓ Unsafe HTML content (dangerousHtml attribute with XSS protection)', 'html-test');
                logger('✓ Complex nested HTML structures', 'html-test');
                logger('✓ Interactive controls to test reactivity', 'html-test');
                
                logger('\nTesting XSS protection:', 'html-test');
                logger('- Script tags should be removed', 'html-test');
                logger('- Event handlers (onclick, onerror) should be stripped', 'html-test');
                logger('- Dangerous elements (iframe, object) should be removed', 'html-test');
                logger('- Safe HTML formatting should be preserved', 'html-test');

                markTestResult('HTML Rendering', true, 'HTML features working with XSS protection');
                
            } catch (error) {
                logger(`ERROR: ${error.message}`, 'html-test');
                markTestResult('HTML Rendering', false, error.message);
            }
        }

        // Test 11: Error Handling
        function testErrorHandling() {
            logger('=== Testing Error Handling ===', 'error-test');
            
            try {
                if (!app) {
                    app = new Juris({ states: { errorCount: 0 } });
                }

                // Clear any existing error demo content first
                const errorDemo = document.getElementById('error-demo');
                if (errorDemo) {
                    errorDemo.innerHTML = '';
                }

                let errorsCaught = 0;

                app.registerComponent('ErrorTestComponent', (props, context) => {
                    logger('ErrorTestComponent: render method called', 'error-test');
                    
                    return {
                        render: () => {
                            logger('ErrorTestComponent: creating render structure', 'error-test');
                            return {
                                div: {
                                    className: 'error-test-container',
                                    style: {
                                        border: '1px solid #ccc',
                                        padding: '10px',
                                        margin: '5px 0'
                                    },
                                    children: [
                                        {
                                            h4: { 
                                                text: 'Error Testing Component',
                                                style: { margin: '0 0 10px 0' }
                                            }
                                        },
                                        {
                                            p: { 
                                                text: () => `Errors caught: ${context.getState('errorCount', 0)}`,
                                                style: { margin: '5px 0' }
                                            }
                                        },
                                        {
                                            button: {
                                                text: 'Test Click Error',
                                                style: { margin: '5px' },
                                                onClick: (e) => {
                                                    logger('Button clicked - about to throw error', 'error-test');
                                                    try {
                                                        throw new Error('Intentional click handler error');
                                                    } catch (error) {
                                                        logger(`Click error caught locally: ${error.message}`, 'error-test');
                                                        errorsCaught++;
                                                        context.setState('errorCount', errorsCaught);
                                                    }
                                                }
                                            }
                                        },
                                        {
                                            button: {
                                                text: 'Test State Error',
                                                style: { margin: '5px' },
                                                onClick: (e) => {
                                                    logger('State error button clicked', 'error-test');
                                                    try {
                                                        // Try to call undefined method
                                                        const result = context.getState('nonexistent.path.method', {});
                                                        result.undefinedMethod();
                                                    } catch (error) {
                                                        logger(`State error caught: ${error.message}`, 'error-test');
                                                        errorsCaught++;
                                                        context.setState('errorCount', errorsCaught);
                                                    }
                                                }
                                            }
                                        },
                                        {
                                            button: {
                                                text: 'Test Render Error',
                                                style: { margin: '5px' },
                                                onClick: (e) => {
                                                    logger('Render error button clicked', 'error-test');
                                                    try {
                                                        // Force a render error by setting invalid state
                                                        context.setState('errorTrigger', { invalidFunction: 'not a function' });
                                                        // Try to use it as a function
                                                        const invalid = context.getState('errorTrigger');
                                                        invalid.invalidFunction();
                                                    } catch (error) {
                                                        logger(`Render error caught: ${error.message}`, 'error-test');
                                                        errorsCaught++;
                                                        context.setState('errorCount', errorsCaught);
                                                    }
                                                }
                                            }
                                        },
                                        {
                                            div: {
                                                style: { 
                                                    marginTop: '10px',
                                                    padding: '5px',
                                                    backgroundColor: '#f0f0f0',
                                                    fontSize: '12px'
                                                },
                                                text: 'All errors are caught and handled gracefully'
                                            }
                                        }
                                    ]
                                }
                            };
                        },

                        onMount: (element, props, context) => {
                            logger('ErrorTestComponent: onMount called', 'error-test');
                            return () => logger('ErrorTestComponent: cleanup called', 'error-test');
                        },

                        onError: (error, element, props, context) => {
                            logger(`ErrorTestComponent onError hook: ${error.message}`, 'error-test');
                            logger(`Error stack: ${error.stack}`, 'error-test');
                            errorsCaught++;
                            context.setState('errorCount', errorsCaught);
                        },

                        onUpdate: (element, newProps, oldProps, context) => {
                            logger('ErrorTestComponent: onUpdate called', 'error-test');
                        }
                    };
                });

                logger('ErrorTestComponent registered successfully', 'error-test');

                // Test the layout setting and rendering
                app.layout = { ErrorTestComponent: {} };
                logger('Layout set to ErrorTestComponent', 'error-test');
                
                app.render('#error-demo');
                logger('Render method called on #error-demo', 'error-test');

                // Verify the component was actually rendered
                setTimeout(() => {
                    const rendered = document.querySelector('#error-demo .error-test-container');
                    if (rendered) {
                        logger('✓ Component successfully rendered in DOM', 'error-test');
                        logger('✓ Error handling hooks configured', 'error-test');
                        logger('✓ Interactive error testing buttons available', 'error-test');
                        markTestResult('Error Handling', true, 'Error handling component rendered and configured');
                    } else {
                        logger('✗ Component not found in DOM after render', 'error-test');
                        logger('DOM content:', 'error-test');
                        logger(document.getElementById('error-demo').innerHTML, 'error-test');
                        markTestResult('Error Handling', false, 'Component failed to render');
                    }
                }, 100);
                
            } catch (error) {
                logger(`SETUP ERROR: ${error.message}`, 'error-test');
                logger(`Error stack: ${error.stack}`, 'error-test');
                markTestResult('Error Handling', false, `Setup failed: ${error.message}`);
            }
        }

        // Global Functions
        function runAllTests() {
            logger('=== Running All Tests ===', 'global-output');
            testStateManagement();
            setTimeout(() => testReactiveComponents(), 100);
            setTimeout(() => testComponentLifecycle(), 200);
            setTimeout(() => testEventHandling(), 300);
            setTimeout(() => testRouter(), 400);
            setTimeout(() => testEnhancement(), 500);
            setTimeout(() => testSubscriptions(), 600);
            setTimeout(() => testComponentAPI(), 700);
            setTimeout(() => testServices(), 800);
            setTimeout(() => testHTMLRendering(), 900);
            setTimeout(() => testErrorHandling(), 1000);
            
            setTimeout(() => {
                logger('=== Test Summary ===', 'global-output');
                const total = Object.keys(testResults).length;
                const passed = Object.values(testResults).filter(r => r.passed).length;
                logger(`Tests passed: ${passed}/${total}`, 'global-output');
                Object.entries(testResults).forEach(([name, result]) => {
                    logger(`${result.passed ? 'PASS' : 'FAIL'}: ${name} - ${result.message}`, 'global-output');
                });
            }, 1000);
        }

        function clearAllOutputs() {
            const outputs = document.querySelectorAll('.code-output');
            outputs.forEach(output => output.textContent = 'Ready to test...');
            testResults = {};
        }

        function inspectFramework() {
            logger('=== Framework Inspection ===', 'global-output');
            if (app) {
                logger(`State: ${JSON.stringify(app.state, null, 2)}`, 'global-output');
                logger(`Components: ${app.components.size}`, 'global-output');
                logger(`Component instances: ${app.componentInstances.size}`, 'global-output');
                logger(`Subscribers: ${app.subscribers.size}`, 'global-output');
                logger(`External subscribers: ${app.externalSubscribers.size}`, 'global-output');
            } else {
                logger('No app instance available', 'global-output');
            }
        }
    </script>
</body>
</html>